"use strict";var ApplicationConfiguration=function(){var applicationModuleName="Nederlandse Rode Kruis Dashboards",applicationModuleVendorDependencies=["ngResource","ngRoute","angularCSS","ngCookies","ngTouch","ngSanitize","ui.router","ui.bootstrap","leaflet-directive","angular-lodash","gettext","AngularDc","angular-loading-bar","pascalprecht.translate"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("dashboards"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("otherwise",{url:"/",templateUrl:"modules/core/views/home.client.view.html"}).state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function($scope,Authentication,Menus){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},angular.element(document).on("click.nav",function(e){$(e.target).is("a")&&$(this).removeClass("in").addClass("collapse")})}]),angular.module("core").controller("HomeController",["$translate","$scope","$css","$rootScope","$compile","Authentication","leafletData",function($translate,$scope,$css,$rootScope,$compile,Authentication,leafletData){$css.remove("modules/dashboards/css/storyboard.css"),$css.remove("modules/dashboards/css/dashboards.css"),$css.add("modules/dashboards/css/header.css"),$scope.authentication=Authentication,$rootScope.country_code="",$rootScope.disaster_type="",$rootScope.view_code="",$scope.choose_country=function(country){$(window).scrollTop(0),$rootScope.country_code=country},$scope.setup_PI=function(country,disaster_type){$rootScope.country_code=country,$rootScope.disaster_type=disaster_type},$scope.choose_view=function(view){$(window).scrollTop(0),$rootScope.view_code=view};var map;dc.chartRegistry.clear(),void 0!==map&&map.remove();var map_chart=dc.leafletChoroplethChart("#map-chart");d3.dsv(";")("modules/core/data/country_metadata.csv",function(country_meta){d3.json("modules/core/data/worldmap.json",function(worldmap){var cf=crossfilter(country_meta);cf.country_code=cf.dimension(function(d){return d.country_code});var country_code=cf.country_code.group().reduceSum(function(d){return"all"==d.format?1:"basic"==d.format?2:3}),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var countries=topojson.feature(worldmap,worldmap.objects.countries),lookup={};countries.features.forEach(function(e){lookup[e.properties.id]=String(e.properties.name)}),map_chart.width(660).height(800).dimension(cf.country_code).group(country_code).geojson(countries).colorCalculator(function(d){return"undefined"==typeof d?"#ccc":1==d?"#045a8d":2==d?"#74a9cf":3==d?"#bdc9e1":void 0}).valueAccessor(function(d){return console.log(d),d.value}).featureKeyAccessor(function(feature){return feature.properties.id}).popup(function(d){return lookup[d.key]}).on("filtered",function(chart,filters){$(window).scrollTop(0),$scope.choose_country(chart.filters()[0]),window.location.replace("#!/community_risk")}),dc.renderAll(),map=map_chart.map(),map.fitBounds([[-30,-90],[45,120]])});var sort_by;!function(){var default_cmp=function(a,b){return a==b?0:a<b?-1:1},getCmpFunc=function(primer,reverse){var dfc=default_cmp,cmp=default_cmp;return primer&&(cmp=function(a,b){return dfc(primer(a),primer(b))}),reverse?function(a,b){return-1*cmp(a,b)}:cmp};sort_by=function(){for(var field,name,cmp,fields=[],n_fields=arguments.length,i=0;i<n_fields;i++)field=arguments[i],"string"==typeof field?(name=field,cmp=default_cmp):(name=field.name,cmp=getCmpFunc(field.primer,field.reverse)),fields.push({name:name,cmp:cmp});return function(A,B){for(var name,result,i=0;i<n_fields&&(result=0,field=fields[i],name=field.name,result=field.cmp(A[name],B[name]),0===result);i++);return result}}}(),country_meta.sort(sort_by("format",{name:"country_code",reverse:!1}));for(var ul=document.getElementById("country-items");ul.childElementCount>0;)ul.removeChild(ul.lastChild);for(var formats=[],i=0;i<country_meta.length;i++){var record=country_meta[i];if(formats.indexOf(record.format)<=-1&&formats.length>0){var li2=document.createElement("li");li2.setAttribute("class","divider"),ul.appendChild(li2)}var li=document.createElement("li");ul.appendChild(li);var a=document.createElement("a");a.setAttribute("ng-click","choose_country('"+record.country_code+"')"),a.setAttribute("ng-href","#!/community_risk"),a.setAttribute("role","button"),a.innerHTML="all"==record.format?record.country_name:record.country_name+" ("+record.format+")",$compile(a)($scope),li.appendChild(a),formats.push(record.format)}}),$(document).ready(function(){$(".timer").countTo(),0!==$("#slider").length&&$("#slider").slick({dots:!0,infinite:!1,speed:300,slidesToShow:1,adaptiveHeight:!0,fade:!0,centerMode:!0}),0!==$("#slider_PI").length&&$("#slider_PI").slick({dots:!0,infinite:!1,speed:300,slidesToShow:1,adaptiveHeight:!0,fade:!0,centerMode:!0})}),$scope.changeLanguage=function(langKey){$translate.use(langKey)},$scope.translateData=function(){return{metric_label:$scope.metric,metric_desc:"desc_"+$scope.metric,subtype_selection:$scope.subtype_selection}}}]),angular.module("dashboards").config(["$stateProvider",function($stateProvider){$stateProvider.state("viewDashboard",{url:"/:templateUrl",templateUrl:function($stateParams){return"modules/dashboards/views/"+$stateParams.templateUrl+".client.view.html"}})}]);var angular_vars={metric_label:"{{metric_label | translate}}",metric_label_popup:"{{metric_label_popup | translate}}",metric_desc:"{{metric_desc | translate}}",levelB_selection_pre:"{{levelB_selection_pre | translate}}",levelC_selection_pre:"{{levelC_selection_pre | translate}}"},static_en={COMMUNITY_RISK:"Community Risk",IMPACT_DATABASE:"Impact database",PRIORITY_INDEX:"Priority Index",HOW_IT_WORKS:"How it works",EXPORT:"Export",share_country_url:"Share current country (URL)",share_url:"Share full current settings (URL)",export_csv:"Export (CSV)",export_geojson:"Export (GEOJSON)",about_CRA:"About CRA",COUNTRY:"Country",Map:"Map",Tab:"Tab",selected:" selected",hit:" hit",Select_all:"Select all",risk_score_tag:"Overall composite risk score",hazard_score_tag:"Click for hazard components",vulnerability_score_tag:"Click for vulnerability components",coping_score_tag:"Click for coping capacity components",other_variables:"Other variables",other_variables_tag:"Not part of risk framework, but still relevant.",sort_by:"Sort by ...",indicator_score:"Indicator Score",area_name:"Area name",scroll_top:"Scroll to Top",year_source:"Year source",link_source:"Source link",desc_source:"Description",share_url_title:"Share current settings directly through URL",share_url_copy:"Copy URL",warning:"Warning",ie_warning:"This beta-version is currently best viewed in Google Chrome, and second-best in Firefox or Safari. Internet Explorer works, but has substantial interaction downsides.",go_to_dashboard:"Go to country dashboard",cra_intro1:"Community Risk Assessment - ",cra_intro2:" communities in ",cra_intro3:" countries included",cra_description:"Relieving the suffering of individuals affected by disasters is at the heart of humanitarian action. However, given limited funding, humanitarian actors cannot reach all people in need. They have to identify the geographic areas that are most affected by a humanitarian disaster or crisis and, within those areas, the individuals that are most in need. Currently, this prioritization process takes time and can be subjective. The Community Risk Assessment dashboard forms a data-driven alternative solution.",language:"Language",about:"About",all_yes:"All ",all_no:"",data_preparedness_index:"Data Preparedness Index",dpi_tag:"Completeness, recency and quality of sources"},static_es={COMMUNITY_RISK:"RIESGO COMUNITARIO",IMPACT_DATABASE:"BASE DE DATOS DE IMPACTO",PRIORITY_INDEX:"Índice de prioridad",HOW_IT_WORKS:"Cómo funciona",EXPORT:"Exportar",share_country_url:"Compartir el país actual (URL)",share_url:"Compartir la configuración actual (URL)",export_csv:"Exportar (CSV)",export_geojson:"Exportar (GEOJSON)",about_CRA:"Sobre CRA",COUNTRY:"País",Map:"Mapa",Tab:"Tabular",selected:" seleccionado",hit:" afectado",Select_all:"Seleccionar todo",risk_score_tag:"Índice de riesgo global compuesto",hazard_score_tag:"Haga clic para los componentes peligrosos",vulnerability_score_tag:"Haga clic para ver los componentes de vulnerabilidad",coping_score_tag:"Haga clic para conocer los componentes de la capacidad de afrontamiento",other_variables:"Otras variables",other_variables_tag:"No forma parte del marco de riesgo, pero sigue siendo relevante.",sort_by:"Ordenar por ...",indicator_score:"Puntaje Indicador",area_name:"Nombre del área",scroll_top:"Vuelve al comienzo",year_source:"Año de origen",link_source:"Enlace de origen",desc_source:"Descripción",share_url_title:"Comparte la configuración actual directamente a través de la URL",share_url_copy:"Copiar URL",warning:"Advertencia",ie_warning:"Actualmente, esta versión beta se visualiza mejor en el navegador Google Chrome, seguido de Firefox o Safari. Internet Explorer funciona, pero tiene desventajas sustanciales de interacción.",go_to_dashboard:"Ir al panel de país",cra_intro1:"Community Risk Assessment - ",cra_intro2:" comunidades en ",cra_intro3:" países incluídos",cra_description:"El propósito de la acción humanitaria es aliviar el sufrimiento de las personas afectadas por desastres. Sin embargo, los actores humanitarios no siempre pueden llegar a todas las personas necesitadas debido a los fondos limitados. Es por esto que se deben identificar las áreas geográficas más afectadas por crisis o desastres humanitarios y, dentro de esas áreas, las personas que están más necesitadas. Actualmente, este proceso de priorización requiere tiempo y puede ser subjetivo. La plataforma de Evaluación de riesgos de la comunidad propone una solución alternativa basada en datos.",language:"Idioma",all_yes:"Todos ",all_no:"",data_preparedness_index:"Índice de preparación de datos",dpi_tag:"Integridad, actualidad y calidad de las fuentes"},static_fr={COMMUNITY_RISK:"Risques Communautaires",IMPACT_DATABASE:"Base de Données d'Impact",PRIORITY_INDEX:"Indice de priorité",HOW_IT_WORKS:"Comment ça marche",EXPORT:"Exporter",share_url:"Partager la configuration actuelle (URL)",export_csv:"Exporter (CSV)",export_geojson:"Exporter (GEOJSON)",COUNTRY:"Pays",Map:"Carte",Tab:"Onglet",selected:" sélectionné",Select_all:"Tout sélectionner",risk_score_tag:"Indice global de risque",hazard_score_tag:"Cliquez pour voir les composantes d'alea",vulnerability_score_tag:"Cliquez pour voir les composantes de vulnérabilité",coping_score_tag:"Cliquez pour voir les composantes de capacité d'adaptation",other_variables:"Autres indicateurs",other_variables_tag:"En dehors de l'équation du risque, mais toujours pertinent.",sort_by:"Trier par ...",indicator_score:"Résultat de l'indicateur",area_name:"Nom de la région",scroll_top:"Retour en haut",year_source:"Année de la référence",link_source:"Lien vers la référence",desc_source:"Description",share_url_title:"Partager la configuration actuelle avec un lien",share_url_copy:"Copier le lien",warning:"Avertissement",ie_warning:"Cette version beta est mieux accessible avec Google Chrome et ensuite avec Firefox ou Safari. Internet Explorer fonctionne aussi, mais l'accès n'est pas optimal.",go_to_dashboard:"Vers le tableau de bord",cra_intro1:"Evaluation des Risques Communautaires - ",cra_intro2:" communautés dans ",cra_intro3:" pays",cra_description:"Le but de l'action humanitaire est de soulager la souffrance des individus touchés par des catastrophes. Cependant, le financement est limité et l'action humanitaire ne pourra pas accéder à toutes les personnes ayant besoin d'aide. Il faut identifier les zones géographiques les plus vulnérables aux catastrophes et crises humanitaires, avant d'identifier les personnes qui ont le plus besoin d'aide. En ce moment, ce procès d'identification prend beaucoup de temps et peut-être subjectif. Le tableau de bord de l'Evaluation des Risques Communautaires propose une solution basée sur des données.",language:"Langue",about_CRA:"À propos de l'ERC",share_country_url:"Partager le pays actuel (URL)",all_yes:"Tout ",all_no:"",data_preparedness_index:"Statut des données disponibles",dpi_tag:"Degré d'actualité, qualité et exhaustivité des données"};angular.module("dashboards").config(function($translateProvider){d3.dsv(";","text/plain; charset=ISO-8859-1")("modules/dashboards/data/metadata_prototype.csv",function(metadata){for(var labels_en={},descriptions_en={},labels_es={},descriptions_es={},labels_fr={},descriptions_fr={},i=0;i<metadata.length;i++)labels_en[metadata[i].variable]=metadata[i].label,descriptions_en["desc_"+metadata[i].variable]=metadata[i].description,metadata[i].label_espanol&&(labels_es[metadata[i].variable]=metadata[i].label_espanol,descriptions_es["desc_"+metadata[i].variable]=metadata[i].description_espanol),metadata[i].label_french&&(labels_fr[metadata[i].variable]=metadata[i].label_french,descriptions_fr["desc_"+metadata[i].variable]=metadata[i].description_french);$translateProvider.translations("en",$.extend({},angular_vars,static_en,labels_en,descriptions_en)),$translateProvider.translations("es",$.extend({},angular_vars,static_es,labels_es,descriptions_es)),$translateProvider.translations("fr",$.extend({},angular_vars,static_fr,labels_fr,descriptions_fr))}),$translateProvider.preferredLanguage("en"),$translateProvider.fallbackLanguage("en")}),angular.module("dashboards").controller("CommunityRiskController",["$translate","$scope","$css","$rootScope","$compile","$q","Authentication","Data","$window","$stateParams","cfpLoadingBar",function($translate,$scope,$css,$rootScope,$compile,$q,Authentication,Data,$window,$stateParams,cfpLoadingBar){$css.remove(["modules/dashboards/css/core.css"]),$css.add(["modules/dashboards/css/header.css","modules/dashboards/css/dashboards.css"]),$scope.change_view=function(view){$rootScope.view_code=view},$scope.change_country=function(country){$scope.country_code=country,$scope.parent_codes=[],$scope.metric="",$scope.initiate($rootScope.view_code)},$rootScope.loadCount=0,$scope.reload=0,$scope.authentication=Authentication,$scope.geom=null,$scope.country_code="PHL",$scope.view_code="CRA",$scope.metric="",$rootScope.country_code&&($scope.country_code=$rootScope.country_code),$rootScope.country_code=null,$rootScope.view_code&&($scope.view_code=$rootScope.view_code),$scope.metric_label="",$scope.metric_year="",$scope.metric_source="",$scope.metric_desc="",$scope.metric_icon="",$scope.admlevel_text="",$scope.data_upload_warning="",$scope.name_selection="",$scope.name_selection_prev="",$scope.name_popup="",$scope.value_popup=0,$scope.country_selection="",$scope.parent_codes=[],$scope.data_input="",$scope.filters=[],$scope.tables=[],$scope.x=500,$scope.y=200,$scope.quantileColorDomain_CRA_std=["#f1eef6","#bdc9e1","#74a9cf","#2b8cbe","#045a8d"],$scope.quantileColorDomain_CRA_scores=["#1a9641","#a6d96a","#f1d121","#fd6161","#d7191c"];var map,mapfilters_length=0,d_prev="";$scope.config={whereFieldName:"pcode",joinAttribute:"pcode",nameAttribute:"name",color:"#0080ff"},$scope.map_filters=[],$scope.row_filters=[],$scope.start=function(){cfpLoadingBar.start()},$scope.complete=function(){cfpLoadingBar.complete()},$scope.replace_null=function(value){return null!=value&&"null"!=value&&value?value:""},$scope.initiate=function(view_code){$scope.start(),$("#row-chart-container").hide(),$("#map-chart").show(),$scope.chart_show="map";var url=location.href;url.indexOf("?")>-1?(url=url.split("?")[1],$scope.country_code=url.split("&")[0].split("=")[1].toUpperCase(),url.split("&")[1]?($scope.directURLload=!0,$scope.admlevel=url.split("&")[1].split("=")[1],$scope.metric=url.split("&")[2].split("=")[1],$scope.chart_show=url.split("&")[4].split("=")[1],$scope.parent_codes=""==url.split("&")[3].split("=")[1]?[]:url.split("&")[3].split("=")[1].split(",")):$scope.directURLload=!1,window.history.pushState({},document.title,"/#!/community_risk")):$scope.directURLload=!1,$scope.directURLload||($scope.admlevel="CRA"==$scope.view_code?1:3,"CRA"==$scope.view_code&&["PHL","MWI","NPL","LKA","MOZ"].indexOf($scope.country_code)>-1&&($scope.admlevel=2)),$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Data.get({adminLevel:$scope.data_input},function(pgData){$scope.load_data(pgData)})},$scope.load_data=function(pgData){var d={};d.Districts=pgData.usp_data.geo,d.Districts.features=$.grep(d.Districts.features,function(e){return null!==e.properties.pcode}),$scope.geom=d.Districts,d.Rapportage=[];for(var i=0;i<d.Districts.features.length;i++)d.Rapportage[i]=d.Districts.features[i].properties;if(d.dpi_temp=pgData.usp_data.dpi,d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata_full=pgData.usp_data.meta_indicators,d.Metadata=$.grep(d.Metadata_full,function(e){return("CRA"==e.view_code||"CRA,PI"==e.view_code)&&$scope.replace_null(e.country_code).indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}),d.Country_meta_full=pgData.usp_data.meta_country,d.Country_meta=$.grep(d.Country_meta_full,function(e){return e.country_code==$scope.country_code}),console.log(d),document.getElementsByClassName("sidebar-wrapper")[0].setAttribute("style",""),document.getElementById("mapPopup").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",document.getElementById("level2")&&document.getElementById("level2").setAttribute("class","btn btn-secondary"),document.getElementById("level3")&&document.getElementById("level3").setAttribute("class","btn btn-secondary"),$(".sidebar-wrapper").addClass("in"),$(document).ready(function(){$(window).width()<768&&$(".sidebar-wrapper").removeClass("in")});for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in");$(".view-buttons button.active").removeClass("active"),"map"==$scope.chart_show?$(".view-buttons button.btn-map-view").addClass("active"):$(".view-buttons button.btn-tabular").addClass("active"),$scope.generateCharts(d),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")}),$scope.complete(),0==$rootScope.loadCount&&"undefined"!=typeof L_PREFER_CANVAS&&($("#IEmodal").modal("show"),$rootScope.loadCount+=1)},$scope.reinitiate=function(d){$scope.start(),$("#row-chart-container").hide(),$("#map-chart").show(),$scope.chart_show="map",$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Data.get({adminLevel:$scope.data_input},function(pgData){$scope.reload_data(d,pgData)})},$scope.reload_data=function(d,pgData){d.Districts=pgData.usp_data.geo,$scope.geom=pgData.usp_data.geo,d.Rapportage=[];for(var i=0;i<d.Districts.features.length;i++)d.Rapportage[i]=d.Districts.features[i].properties;if(d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata=$.grep(d.Metadata_full,function(e){return("CRA"==e.view_code||"CRA,PI"==e.view_code)&&$scope.replace_null(e.country_code).indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}),$(".view-buttons button.active").removeClass("active"),$(".view-buttons button.btn-map-view").addClass("active"),$scope.reload=1,$scope.generateCharts(d),$scope.complete()},$scope.genLookup=function(field){var lookup={};return $scope.geom.features.forEach(function(e){lookup[e.properties[$scope.config.joinAttribute]]=String(e.properties[field])}),lookup},$scope.genLookup_meta=function(d,field){var lookup_meta={};return d.Metadata.forEach(function(e){lookup_meta[e.variable]=$scope.replace_null(String(e[field]))}),lookup_meta},$scope.genLookup_country_meta=function(d,field){var lookup_country_meta={};return d.Country_meta.forEach(function(e){lookup_country_meta[e.country_code]=String(e[field])}),lookup_country_meta},$scope.generateCharts=function(d){function addParameterToURL(view,country,admlevel,metric,parent_codes,chart_show){var _url=location.href;return _url=_url.split("?")[0],_url+=(_url.split("?")[1]?"&":"?")+"country="+country+"&admlevel="+admlevel+"&metric="+metric+"&parent_code="+parent_codes+"&view="+chart_show}function zoomToGeom(geom){var bounds=d3.geo.bounds(geom);map.fitBounds([[bounds[0][1],bounds[0][0]],[bounds[1][1],bounds[1][0]]])}dc.chartRegistry.clear(),void 0!==map&&map.remove();var mapChart=dc.leafletChoroplethChart("#map-chart"),rowChart=dc.rowChart("#row-chart"),country_name=$scope.genLookup_country_meta(d,"country_name"),country_zoom_min=($scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name"),$scope.genLookup_country_meta(d,"zoomlevel_min")),country_zoom_max=$scope.genLookup_country_meta(d,"zoomlevel_max"),country_default_metric=$scope.genLookup_country_meta(d,"default_metric"),country_status=$scope.genLookup_country_meta(d,"format")[$scope.country_code];if("template"==country_status)document.getElementById("status").style.visibility="visible",$scope.status_title="Template only",$scope.status_text="This dashboard is only a template with administrative boundaries and population data. It is yet to be filled with actual risk data";else if("basic"==country_status)document.getElementById("status").style.visibility="visible",$scope.status_title="Draft version",$scope.status_text="This dashboard is filled with a limited number of indicators only, which need to be checked in terms of quality and use. Not to be used for external sharing and/or drawing conclusions yet.";else if("all"==country_status){var dpi=d.dpi[0].dpi_score;dpi>.1?(document.getElementById("status").style.visibility="hidden",$scope.status_title="",$scope.status_text=""):(document.getElementById("status").style.visibility="visible",$scope.status_title="Needs data",$scope.status_text="The Data Preparedness Index of the risk framework for this administrative level falls below the threshold for meaningful interpretation. It needs either more, newer or better data sources. The indicators that are included (e.g. population, poverty) can still be used on their own.")}$scope.country_selection=country_name[$scope.country_code];var zoom_min=Number(country_zoom_min[$scope.country_code]),zoom_max=Number(country_zoom_max[$scope.country_code]);$scope.inform_admlevel=Number($scope.genLookup_country_meta(d,"inform_admlevel")[$scope.country_code]),$scope.directURLload||(""===$scope.metric?$scope.metric=country_default_metric[$scope.country_code]:"undefined"==typeof d.Rapportage[0][$scope.metric]&&($scope.metric="population")),$scope.admlevel===zoom_min&&($scope.name_selection=country_name[$scope.country_code]),zoom_max-zoom_min<2?document.getElementById("level3").style.visibility="hidden":document.getElementById("level3")&&(document.getElementById("level3").style.visibility="visible");var lookup=$scope.genLookup($scope.config.nameAttribute),meta_label=$scope.genLookup_meta(d,"label"),meta_format=$scope.genLookup_meta(d,"format"),meta_unit=$scope.genLookup_meta(d,"unit"),meta_icon=$scope.genLookup_meta(d,"icon_src"),meta_year=$scope.genLookup_meta(d,"year"),meta_source=$scope.genLookup_meta(d,"source_link"),meta_desc=$scope.genLookup_meta(d,"description"),meta_scorevar=$scope.genLookup_meta(d,"scorevar_name");$scope.metric_label=meta_label[$scope.metric],$scope.type_selection=$scope.admlevel==zoom_min?"Country":$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code],$scope.subtype_selection=$scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name")[$scope.country_code],$scope.levelB_selection_pre="all_no",1==zoom_min||"MWI"==$scope.country_code||"MOZ"==$scope.country_code?($("#level2").addClass("btn-zoomin"),$("#level3").addClass("btn-zoomin"),$scope.admlevel==zoom_min?($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]):$scope.admlevel<zoom_max&&$scope.parent_codes.length>0?($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes):$scope.admlevel<zoom_max&&0==$scope.parent_codes.length?($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]):$scope.admlevel==zoom_max&&0==$scope.parent_codes.length&&($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]),$scope.admlevel<zoom_max?($scope.levelC_selection_pre=0==$scope.parent_codes.length?"all_yes":void 0,$scope.levelC_selection=0==$scope.parent_codes.length?$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code]:void 0,$scope.levelC_code=""):$scope.admlevel==zoom_max&&0==$scope.parent_codes.length?($scope.levelC_selection_pre=0==$scope.parent_codes.length?"all_yes":void 0,$scope.levelC_selection=0==$scope.parent_codes.length?$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code]:void 0,$scope.levelC_code=""):$scope.parent_codes.length>0&&($scope.levelC_selection=$scope.name_selection,$scope.levelC_code=$scope.parent_code)):($("#level2").removeClass("btn-zoomin"),$("#level3").removeClass("btn-zoomin"),$scope.admlevel==zoom_min?($scope.levelB_selection=void 0,$scope.levelB_codes=[]):$scope.admlevel<=zoom_max&&void 0==$scope.levelB_selection&&($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes),$scope.levelC_selection=$scope.admlevel<zoom_max?void 0:$scope.name_selection,$scope.levelC_code=$scope.admlevel<zoom_max?"":$scope.parent_code);var dec0Format=(d3.format(","),d3.format(",.0f")),dec2Format=(d3.format(",.1f"),d3.format(".2f")),percFormat=d3.format(",.2%"),currentFormat=function(value){return"decimal0"===meta_format[$scope.metric]?dec0Format(value):"decimal2"===meta_format[$scope.metric]?dec2Format(value):"percentage"===meta_format[$scope.metric]?percFormat(value):void 0};d.Metadata.sort(function(a,b){return a.order-b.order}),$scope.tables=[];for(var j=0,i=0;i<d.Metadata.length;i++){var record={},record_temp=d.Metadata[i];"admin"!==record_temp.group&&(record.id="data-table"+[i+1],record.name=record_temp.variable,record.group=record_temp.group,record.propertyPath="sum"===record_temp.agg_method?"value":"value.finalVal",record.dimension=void 0,record.weight_var=record_temp.weight_var,record.scorevar_name=record_temp.scorevar_name,record.view="CRA",$scope.tables[j]=record,j+=1)}var cf=crossfilter(d.Rapportage),whereDimension=cf.dimension(function(d){return d.pcode}),whereDimension_tab=cf.dimension(function(d){return d.pcode}),whereGroupSum=whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereGroupSum_lookup=(whereDimension_tab.group().reduceSum(function(d){return d[$scope.metric]}),whereDimension.group().reduce(function(p,v){return p.count=null!==v[$scope.metric]?p.count+1:p.count,p.sum=p.sum+v[$scope.metric],p},function(p,v){return p.count=null!==v[$scope.metric]?p.count-1:p.count,p.sum=p.sum-v[$scope.metric],p},function(){return{count:0,sum:0}}));$scope.genLookup_value=function(){var lookup_value={};return whereGroupSum_lookup.top(1/0).forEach(function(e){lookup_value[e.key]=0==e.value.count?"No data":e.value.sum}),lookup_value};var cf_scores_metric=meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric,whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var reduceAddAvg=function(metricA,metricB){return function(p,v){return p.count=null!==v[metricA]?p.count+1:p.count,p.sumOfSub+=v[metricA]*v[metricB],p.sumOfTotal+=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceRemoveAvg=function(metricA,metricB){return function(p,v){return p.count=null!==v[metricA]?p.count-1:p.count,p.sumOfSub-=v[metricA]*v[metricB],p.sumOfTotal-=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceInitialAvg=function(){return{count:0,sumOfSub:0,sumOfTotal:0,finalVal:0}},totaalDim=cf.dimension(function(i){return"Total"}),dimensions=[];$scope.tables.forEach(function(t){var name=t.name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions[name]=totaalDim.group().reduce(reduceAddAvg([name],[weight_var]),reduceRemoveAvg([name],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions[name]=totaalDim.group().reduceSum(function(d){return d[name]}))});var dimensions_scores=[];$scope.tables.forEach(function(t){var name=t.name;if(t.scorevar_name){var name_score=t.scorevar_name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions_scores[name]=totaalDim.group().reduce(reduceAddAvg([name_score],[weight_var]),reduceRemoveAvg([name_score],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions_scores[name]=totaalDim.group().reduceSum(function(d){return d[name_score]}))}});var i;for(i=0;i<$scope.tables.length;i++){var name=$scope.tables[i].name;$scope.tables[i].dimension=dimensions[name]}var fill_keyvalues=function(){var keyvalue=[];return $scope.tables.forEach(function(t){var key=t.name;"dpi"==t.group?keyvalue[key]=dec2Format(d.dpi[0][t.name]):$scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[t.name])?"value.finalVal"===t.propertyPath?isNaN(dimensions[t.name].top(1)[0].value.finalVal)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value.finalVal):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value.finalVal):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value.finalVal)):"value"===t.propertyPath&&(isNaN(dimensions[t.name].top(1)[0].value)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value))):"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(d_prev[t.name]):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(d_prev[t.name]):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(d_prev[t.name]));
}),keyvalue},keyvalue=fill_keyvalues();if($scope.admlevel==zoom_min||$scope.directURLload){var quantile_range_scores=[],j=0;for(i=0;i<d.Rapportage.length;i++)Object.keys(d.Rapportage[i]).forEach(function(key,index){meta_scorevar[key]&&(d.Rapportage[i][meta_scorevar[key]]||0==d.Rapportage[i][meta_scorevar[key]])&&(quantile_range_scores[j]=d.Rapportage[i][meta_scorevar[key]],j+=1)});quantile_range_scores.sort(function(a,b){return a-b}),d.quantile_range_scores=quantile_range_scores;for(var quantile=function(values,p){var H=(values.length-1)*p+1,h=Math.floor(H),v=+values[h-1],e=H-h;return e?v+e*(values[h]-v):v},k=0,q=5,thresholds=[];++k<q;)thresholds[k-1]=Math.round(100*quantile(quantile_range_scores,k/q))/100;d.thresholds=thresholds}var high_med_low=function(ind,ind_score,group){if(dimensions_scores[ind]){if("dpi"==group)var width=10*(1-d.dpi[0][ind]);else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[ind_score]))if(0==dimensions_scores[ind].top(1)[0].value.count)var width="na";else var width=dimensions_scores[ind].top(1)[0].value.finalVal;else var width=d_prev[ind_score];if("dpi_score"==ind)return 1-width/10<.1?"bad":"good";if(isNaN(width))return"notavailable";if(width<d.thresholds[0])return"good";if(width<=d.thresholds[1])return"medium-good";if(width<=d.thresholds[2])return"medium";if(width<=d.thresholds[3])return"medium-bad";if(width>d.thresholds[3])return"bad"}};$scope.createHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));var general=document.getElementById("general"),dpi=document.getElementById("dpi"),scores=document.getElementById("scores"),vulnerability=document.getElementById("vulnerability"),hazard=document.getElementById("hazard"),coping=document.getElementById("coping_capacity"),other=document.getElementById("other");if(general)for(;general.firstChild;)general.removeChild(general.firstChild);if(dpi)for(;dpi.firstChild;)dpi.removeChild(dpi.firstChild);if(scores)for(;scores.firstChild;)scores.removeChild(scores.firstChild);if(vulnerability)for(;vulnerability.firstChild;)vulnerability.removeChild(vulnerability.firstChild);if(hazard)for(;hazard.firstChild;)hazard.removeChild(hazard.firstChild);if(coping)for(;coping.firstChild;)coping.removeChild(coping.firstChild);if(other)for(;other.firstChild;)other.removeChild(other.firstChild);for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if(meta_icon[record.name])var icon="modules/dashboards/img/"+meta_icon[record.name];else var icon="modules/dashboards/img/undefined.png";if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div=document.createElement("div");div.setAttribute("class","row profile-item"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col col-md-1 col-sm-1 col-xs-1"),div.appendChild(div0);var img=document.createElement("img");img.setAttribute("class","community-icon"),img.setAttribute("src",icon),div0.appendChild(img);var div1=document.createElement("div");div1.setAttribute("class","col col-md-5 col-sm-5 col-xs-5 general-component-label"),div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",div.appendChild(div1),$compile(div1)($scope);var div2=document.createElement("div");div2.setAttribute("class","col col-md-5 col-sm-5 col-xs-5"),div2.setAttribute("id",record.name),div2.innerHTML=keyvalue[record.name]+" "+unit,div.appendChild(div2);var div3=document.createElement("div");div3.setAttribute("class","col col-md-1 col-sm-1 col-xs-1"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img=document.createElement("img");img.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img.setAttribute("style","height:17px"),button.appendChild(img)}else if("other"===record.group){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div=document.createElement("div");div.setAttribute("class","component-section"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2 col-sm-2 col-xs-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-9 col-sm-9 col-xs-9 component-label"),div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div3=document.createElement("div");div3.setAttribute("class","col-md-1 col-sm-1 col-xs-1 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}else if("hide"!==record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div=document.createElement("div");div.setAttribute("class","component-section"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2 col-sm-2 col-xs-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-4 col-sm-4 col-xs-4 component-label"),"dpi"!==record.group&&div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div2=document.createElement("div");div2.setAttribute("class","col-md-5 col-sm-5 col-xs-5"),div.appendChild(div2);var div2a=document.createElement("div");div2a.setAttribute("class","component-scale"),div2.appendChild(div2a);var div2a1=document.createElement("div");div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("id","bar-"+record.name),div2a1.setAttribute("style","width:"+width+"%"),div2a.appendChild(div2a1);var div3=document.createElement("div");div3.setAttribute("class","col-md-1 col-sm-1 col-xs-1 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}},$scope.createHTML(keyvalue);var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.add("section-active"),$scope.updateHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div2=document.getElementById(record.name);div2.innerHTML=keyvalue[record.name]+" "+unit}else if("other"===record.group){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.innerHTML=keyvalue[record.name]+" "+unit}}else if("hide"!==record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.innerHTML=keyvalue[record.name]+" "+unit;var div2a1=document.getElementById("bar-"+record.name);div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("style","width:"+width+"%")}}},$scope.mapchartColors=function(){var quantile_range=[];if(meta_scorevar[$scope.metric])quantile_range=d.quantile_range_scores;else{for(i=0;i<d.Rapportage.length;i++)d.Rapportage[i][$scope.metric]&&(quantile_range.push(d.Rapportage[i][$scope.metric]),quantile_range.sort(function(a,b){return a-b}));$scope.quantile_max=quantile_range[quantile_range.length-1]}var colorDomain;return colorDomain=meta_scorevar[$scope.metric]?$scope.quantileColorDomain_CRA_scores:$scope.quantileColorDomain_CRA_std,d3.scale.quantile().domain(quantile_range).range(colorDomain)};var mapchartColors=$scope.mapchartColors();$scope.coming_from_map=!1,$scope.coming_from_tab=!1,mapChart.width($("#map-chart").width()).height(800).dimension(whereDimension).group(whereGroupSum_scores).center([0,0]).zoom(0).geojson(d.Districts).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).featureKeyAccessor(function(feature){return feature.properties.pcode}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat($scope.genLookup_value()[d.key])):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).renderPopup(!0).turnOnControls(!0).legend(dc.leafletLegend().position("topright")).on("filtered",function(chart,filters,e){if($scope.filters=chart.filters(),"map"==$scope.chart_show&&$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("map"==$scope.chart_show&&!$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}var popup=document.getElementById("mapPopup");popup.style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.filters.length>mapfilters_length&&($scope.$apply(function(){$scope.name_popup=lookup[$scope.filters[$scope.filters.length-1]];for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[$scope.filters.length-1]){$scope.value_popup=currentFormat(record[$scope.metric]),$scope.value_popup_unit=$scope.replace_null(meta_unit[$scope.metric]);break}}$scope.metric_label=meta_label[$scope.metric]}),$(window).width()<768?(popup.style.left="5px",popup.style.bottom="8%"):"undefined"!=typeof event?(popup.style.left=Math.min($(window).width()-210,event.pageX)+"px",popup.style.top=Math.min($(window).height()-210,event.pageY)+"px"):(popup.style.left=$scope.posx+"px",popup.style.top=$scope.posy+"px"),popup.style.visibility="visible",$scope.admlevel<zoom_max&&"PI"!==$scope.view_code&&(document.getElementById("zoomin_icon").style.visibility="visible")),mapfilters_length=$scope.filters.length,document.getElementById("section-"+$scope.metric).classList.add("section-active")}),$scope.FF_mouse_coordinates=function(e){e=e||window.event,(e.pageX||e.pageY)&&($scope.posx=e.pageX,$scope.posy=e.pageY)};var mapElem=document.getElementById("map-chart");if(mapElem.addEventListener("click",$scope.FF_mouse_coordinates,!1),$(window).width()<768)var rowChart_width=$("#row-chart-container").width();else var rowChart_width=$("#row-chart-container").width()-370;var barheight=20,xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.width(rowChart_width).height((barheight+5)*d.Rapportage.length+50).dimension(whereDimension_tab).group(whereGroupSum_scores_tab).ordering(function(d){return isNaN($scope.genLookup_value()[d.key])?999999999-d.value.sum:-d.value.sum}).fixedBarHeight(barheight).valueAccessor(function(d){return isNaN(d.value.sum)?0:d.value.sum}).colors(mapchartColors).colorCalculator(function(d){return d.value.count?mapChart.colors()(d.value.sum):"#cccccc"}).label(function(d){return meta_scorevar[$scope.metric]?"No data"==$scope.genLookup_value()[d.key]?"No data - ".concat(lookup[d.key]):currentFormat($scope.genLookup_value()[d.key]).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).on("filtered",function(chart,filters){if($scope.filters=chart.filters(),"row"==$scope.chart_show&&$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("row"==$scope.chart_show&&!$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}}).elasticX(!1).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])).xAxis().scale(rowChart.x()).tickValues([]),$scope.row_text=function(color_range){for(var color_level,i=0;i<$(".dc-chart g.row").length;i++){if(row=$(".dc-chart g.row")[i],fill=row.getElementsByTagName("rect")[0].getAttribute("fill"),selection=row.getElementsByTagName("rect")[0].getAttribute("class"),fill)for(j=0;j<color_range.length;j++)if(fill.toString().toLowerCase()==color_range[j].HEX.toLowerCase()){color_level=j;break}title=row.getElementsByTagName("title")[0].innerHTML,title||(string=(new XMLSerializer).serializeToString(row.getElementsByTagName("title")[0]),pos=string.indexOf(">"),title=string.substring(pos+1,pos+4)),text=row.getElementsByTagName("text")[0],"deselected"==selection&&"No Data"==title.substring(0,7)?text.style.fill="white":color_level<=2||"deselected"==selection||!fill||parseInt(title.substring(0,3))<3?text.style.fill="black":text.style.fill="white"}},$scope.sort=function(type){"value"===type?rowChart.ordering(function(d){return isNaN(d.value.sum)?0:-d.value.sum}):"name"==type&&rowChart.ordering(function(d){return 0==d.value?"zzz":lookup[d.key]}),rowChart.redraw()},$scope.scrollRowChart=function(){$("#tabular-wrapper").scrollTop(0)},$scope.zoom_in=function(){if($scope.filters.length>0&&$scope.admlevel<zoom_max){if($scope.admlevel=$scope.admlevel+1,$scope.parent_code_prev=$scope.parent_code,$scope.name_selection_prev=$scope.name_selection,$scope.parent_codes=$scope.filters,$scope.name_selection=$scope.filters.length>1?"Multiple "+$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code]:lookup[$scope.parent_codes[0]],$scope.admlevel==zoom_max)for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[0]){d_prev=record;break}}$scope.filters=[],$scope.reinitiate(d),document.getElementById("level"+($scope.admlevel-zoom_min+1)).setAttribute("class","btn btn-secondary btn-active"),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",mapfilters_length=0}},$scope.zoom_out=function(dest_level){var admlevel_old=$scope.admlevel;for(1==zoom_min||"MWI"==$scope.country_code||"MOZ"==$scope.country_code?1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel>zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.levelC_selection_pre="all_yes",$scope.levelC_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel<zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=[],$scope.name_selection=$scope.levelB_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),$scope.reinitiate(d)):3===dest_level&&$scope.admlevel<zoom_min+2&&0==$scope.parent_codes.length&&($scope.admlevel=zoom_min+2,$scope.parent_codes=[],$scope.name_selection=$scope.levelC_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),document.getElementById("level3").setAttribute("class","btn btn-secondary btn-active"),$scope.reinitiate(d)):1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel>zoom_min+1&&($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.reinitiate(d));admlevel_old-zoom_min>dest_level-1;)document.getElementById("level"+(admlevel_old-zoom_min+1)).setAttribute("class","btn btn-secondary"),admlevel_old-=1;document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.mapShow()},$scope.change_indicator=function(id){var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.remove("section-active"),$scope.metric=id,$scope.metric_label=meta_label[id];var mapchartColors=$scope.mapchartColors();cf_scores_metric=meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric,whereGroupSum.dispose(),whereGroupSum=whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereGroupSum_lookup.dispose(),whereGroupSum_lookup=whereDimension.group().reduce(function(p,v){return p.count=null!==v[$scope.metric]?p.count+1:p.count,p.sum=p.sum+v[$scope.metric],p},function(p,v){return p.count=null!==v[$scope.metric]?p.count-1:p.count,p.sum=p.sum-v[$scope.metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores.dispose(),whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores_tab.dispose(),whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),mapChart.group(whereGroupSum_scores).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat($scope.genLookup_value()[d.key])):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])});var xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.group(whereGroupSum_scores_tab).ordering(function(d){return isNaN($scope.genLookup_value()[d.key])?999999999:-d.value.sum}).valueAccessor(function(d){return isNaN($scope.genLookup_value()[d.key])?"":d.value.sum}).colors(mapchartColors).colorCalculator(function(d){return d.value.count?mapChart.colors()(d.value.sum):"#cccccc"}).label(function(d){return meta_scorevar[$scope.metric]?"No data"==$scope.genLookup_value()[d.key]?"No data - ".concat(lookup[d.key]):currentFormat($scope.genLookup_value()[d.key]).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])),dc.redrawAll(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("section-"+id).classList.add("section-active")},$scope.info=function(id){$scope.metric_info=id,"admin"!==id&&($scope.metric_label=meta_label[id]),$scope.metric_label_popup=meta_label[id],$scope.metric_year=meta_year[id],$scope.metric_source=meta_source[id],$scope.metric_desc=meta_desc[id],meta_icon[id]?$scope.metric_icon="modules/dashboards/img/"+meta_icon[id]:$scope.metric_icon="modules/dashboards/img/undefined.png",$("#infoModal").modal("show")};for(var acc=document.getElementsByClassName("card-header level1"),active=(document.getElementsByClassName("collapse level1"),document.getElementsByClassName("collapse level1 in")[0]),i=0;i<acc.length;i++)acc[i].onclick=function(){var active_new=document.getElementById(this.id.replace("heading","collapse"));active.id!==active_new.id&&active.classList.remove("in"),active=active_new};$scope.open_status=function(){$("#statusModal").modal("show")},$scope.open_DPI=function(){$("#statusModal").modal("hide"),$(".collapse.level1.in").removeClass("in"),$("#collapseZero").addClass("in"),setTimeout(function(){$("#dpi-card").addClass("dpi-card-highlight")},100),setTimeout(function(){$(" #dpi-card").removeClass("dpi-card-highlight")},1e3)},$scope.export_geojson=function(){var myWindow=window.open("","","_blank");myWindow.document.write(JSON.stringify(d.Districts)),myWindow.focus()},$scope.export_csv=function(){for(var content=d.Rapportage,finalVal="",i=0;i<content.length;i++){var key,innerValue,result,value=content[i];if(0===i){for(key in value)value.hasOwnProperty(key)&&(innerValue=meta_label[key]?meta_label[key]:meta_label[key.replace("_score","")]?meta_label[key.replace("_score","")]+" (0-10)":key,result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}for(key in value)value.hasOwnProperty(key)&&(innerValue=JSON.stringify(value[key]),result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}var download=document.getElementById("download");download.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(finalVal)),download.setAttribute("download","export.csv")},$scope.share_URL=function(){$scope.shareable_URL=addParameterToURL($scope.view_code,$scope.country_code,$scope.admlevel,$scope.metric,$scope.parent_codes,$scope.chart_show),$("#URLModal").modal("show")},$scope.share_country_URL=function(){$scope.shareable_URL=location.href+"?country="+$scope.country_code,$("#URLModal").modal("show")},$scope.copyToClipboard=function(element){var $temp=$("<input>");$("body").append($temp),$temp.val($(element).text()).select(),document.execCommand("copy"),$temp.remove()},$scope.tutorial=function(){($scope.view_code="PI")?window.open("#!/#walkthrough_PI","_blank"):window.open("#!/#walkthrough","_blank")},$scope.data_upload=function(){$("#uploadModal").modal("show")},$(document).ready(function(){function browserSupportFileUpload(){var isCompatible=!1;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(isCompatible=!0),isCompatible}function upload(evt){if(browserSupportFileUpload()){var file=evt.target.files[0],reader=new FileReader;reader.readAsText(file),reader.onload=function(event){$scope.csvData=event.target.result},reader.onerror=function(){alert("Unable to read "+file.fileName)}}else alert("The File APIs are not fully supported in this browser!")}document.getElementById("txtFileUpload").addEventListener("change",upload,!1)}),$scope.submit_data=function(){for(var separator=$("#separator").val(),data=$.csv.toArrays($scope.csvData,{separator:separator}),pcode_check=0,pcode_col=0,i=0;i<data[0].length;i++)if("pcode"==data[0][i].toLowerCase()){data[0][i]=data[0][i].toLowerCase(),pcode_col=i,pcode_check=1;break}if(0==pcode_check)$scope.data_upload_warning="No column named 'pcode' is found. Please change the input-file accordingly. Note that a reason for this can also be that the field-separator is not correct.",$("#uploadWarningModal").modal("show");else{for(var counts=[],pcode_dup_check=0,j=0;j<data.length;j++){if(void 0!==counts[data[j][pcode_col]]){pcode_dup_check=1;break}counts[data[j][pcode_col]]=1}1==pcode_dup_check&&($scope.data_upload_warning="Duplicate values are found in pcode-column. Please change the input-file accordingly.",$("#uploadWarningModal").modal("show"))}},$scope.mapShow=function(){if(0==$scope.filters.length)zoomToGeom($scope.geom);else{$scope.districts_temp=JSON.parse(JSON.stringify($scope.geom)),$scope.districts_temp.features=[];for(var i=0;i<$scope.geom.features.length;i++)$scope.filters.indexOf($scope.geom.features[i].properties.pcode)>-1&&$scope.districts_temp.features.push($scope.geom.features[i]);zoomToGeom($scope.districts_temp)}"row"==$scope.chart_show&&($scope.chart_show="map",$("#row-chart-container").hide(),$("#map-chart").show(),$scope.click_filter=!1,$scope.coming_from_tab=!0,rowChart.filter(null),$scope.click_filter=!0,$scope.coming_from_tab=!1),$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$scope.tabularShow=function(){$scope.chart_show="row",$("#map-chart").hide(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("row-chart-container").style.visibility="visible",$("#row-chart-container").show(),$scope.click_filter=!1,$scope.coming_from_map=!0,mapChart.filter(null),$scope.click_filter=!0,$scope.coming_from_map=!1,$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$(".view-buttons button").click(function(e){$(".view-buttons button.active").removeClass("active");var $this=$(this);$this.hasClass("active")||$this.addClass("active"),e.preventDefault()}),$scope.reset_function=function(){dc.filterAll(),dc.redrawAll();var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue),"map"==$scope.chart_show&&zoomToGeom($scope.geom)},dc.renderAll(),map=mapChart.map(),zoomToGeom($scope.geom),"map"==$scope.chart_show?$("#row-chart-container").hide():"row"==$scope.chart_show&&$scope.tabularShow();var zoom_child=$(".leaflet-control-zoom")[0],zoom_parent=$(".leaflet-bottom.leaflet-right")[0];zoom_parent.insertBefore(zoom_child,zoom_parent.childNodes[0]);var sort_by;if(function(){var default_cmp=function(a,b){return a==b?0:a<b?-1:1},getCmpFunc=function(primer,reverse){var dfc=default_cmp,cmp=default_cmp;return primer&&(cmp=function(a,b){return dfc(primer(a),primer(b))}),reverse?function(a,b){return-1*cmp(a,b)}:cmp};sort_by=function(){for(var field,name,cmp,fields=[],n_fields=arguments.length,i=0;i<n_fields;i++)field=arguments[i],"string"==typeof field?(name=field,cmp=default_cmp):(name=field.name,cmp=getCmpFunc(field.primer,field.reverse)),fields.push({name:name,cmp:cmp});return function(A,B){
for(var name,result,i=0;i<n_fields&&(result=0,field=fields[i],name=field.name,result=field.cmp(A[name],B[name]),0===result);i++);return result}}}(),d.Country_meta_full.sort(sort_by("format",{name:"country_code",reverse:!1})),"CRA"==$scope.view_code){for(var ul=document.getElementById("country-items");ul.childElementCount>0;)ul.removeChild(ul.lastChild);for(var formats=[],i=0;i<d.Country_meta_full.length;i++){var record=d.Country_meta_full[i];if(formats.indexOf(record.format)<=-1&&formats.length>0){var li2=document.createElement("li");li2.setAttribute("class","divider"),ul.appendChild(li2)}var li=document.createElement("li");ul.appendChild(li);var a=document.createElement("a");a.setAttribute("class","submenu-item"),a.setAttribute("ng-click","change_country('"+record.country_code+"')"),a.setAttribute("role","button"),a.innerHTML="all"==record.format?record.country_name:record.country_name+" ("+record.format+")",$compile(a)($scope),li.appendChild(a),formats.push(record.format)}}$scope.changeLanguage=function(langKey){$translate.use(langKey),$scope.language=langKey;for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in")};var languages_es=["PER","ECU"],languages_fr=[],languages_all=[].concat(languages_es,languages_fr);languages_all.indexOf($scope.country_code)>-1?(document.getElementById("language-selector").style.display="block",1==$scope.reload&&"en"==$scope.language?$scope.changeLanguage("en"):languages_fr.indexOf($scope.country_code)>-1?($scope.changeLanguage("fr"),document.getElementById("language-selector-es").style.display="none",document.getElementById("language-selector-fr").style.display="block"):languages_es.indexOf($scope.country_code)>-1&&($scope.changeLanguage("es"),document.getElementById("language-selector-es").style.display="block",document.getElementById("language-selector-fr").style.display="none")):(document.getElementById("language-selector").style.display="none",$scope.changeLanguage("en")),$scope.translateData=function(){return{metric_label:$scope.metric,metric_label_popup:$scope.metric_info,metric_desc:"desc_"+$scope.metric_info,subtype_selection:$scope.subtype_selection,levelB_selection_pre:$scope.levelB_selection_pre,levelC_selection_pre:$scope.levelC_selection_pre}}}}]),angular.module("dashboards").controller("FbfController",["$translate","$scope","$css","$rootScope","$compile","$q","Authentication","Data","$window","$stateParams","cfpLoadingBar",function($translate,$scope,$css,$rootScope,$compile,$q,Authentication,Data,$window,$stateParams,cfpLoadingBar){$css.remove(["modules/dashboards/css/core.css"]),$css.add(["modules/dashboards/css/header.css","modules/dashboards/css/dashboards.css"]),$scope.change_view=function(view){$rootScope.view_code=view},$scope.change_country=function(country){$scope.country_code=country,$scope.parent_codes=[],$scope.metric="",$scope.initiate($rootScope.view_code)},$rootScope.loadCount=0,$scope.reload=0,$scope.authentication=Authentication,$scope.geom=null,$scope.country_code="ZMB",$scope.view_code="CRA",$scope.metric="",$rootScope.country_code&&($scope.country_code=$rootScope.country_code),$rootScope.country_code=null,$rootScope.view_code&&($scope.view_code=$rootScope.view_code),$scope.metric_label="",$scope.metric_year="",$scope.metric_source="",$scope.metric_desc="",$scope.metric_icon="",$scope.admlevel_text="",$scope.data_upload_warning="",$scope.name_selection="",$scope.name_selection_prev="",$scope.name_popup="",$scope.value_popup=0,$scope.country_selection="",$scope.parent_codes=[],$scope.data_input="",$scope.filters=[],$scope.tables=[],$scope.x=500,$scope.y=200,$scope.quantileColorDomain_CRA_std=["#f1eef6","#bdc9e1","#74a9cf","#2b8cbe","#045a8d"],$scope.quantileColorDomain_CRA_scores=["#1a9641","#a6d96a","#f1d121","#fd6161","#d7191c"];var map,map2,mapfilters_length=0,d_prev="";$scope.config={whereFieldName:"pcode",joinAttribute:"pcode",nameAttribute:"name",color:"#0080ff"},$scope.map_filters=[],$scope.row_filters=[],$scope.start=function(){cfpLoadingBar.start()},$scope.complete=function(){cfpLoadingBar.complete()},$scope.replace_null=function(value){return null!=value&&"null"!=value&&value?value:""},$scope.initiate=function(view_code){$scope.start(),$("#row-chart-container").hide(),$("#map-chart").show(),$scope.chart_show="map";var url=location.href;url.indexOf("?")>-1?(url=url.split("?")[1],$scope.country_code=url.split("&")[0].split("=")[1].toUpperCase(),url.split("&")[1]?($scope.directURLload=!0,$scope.admlevel=url.split("&")[1].split("=")[1],$scope.metric=url.split("&")[2].split("=")[1],$scope.chart_show=url.split("&")[4].split("=")[1],$scope.parent_codes=""==url.split("&")[3].split("=")[1]?[]:url.split("&")[3].split("=")[1].split(",")):$scope.directURLload=!1,window.history.pushState({},document.title,"/#!/community_risk")):$scope.directURLload=!1,$scope.directURLload||($scope.admlevel="CRA"==$scope.view_code?1:3,"CRA"==$scope.view_code&&["PHL","MWI","NPL","LKA","MOZ"].indexOf($scope.country_code)>-1&&($scope.admlevel=2)),$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Data.get({adminLevel:$scope.data_input},function(pgData){$scope.load_data(pgData)})},$scope.load_data=function(pgData){var d={};d.Districts=pgData.usp_data.geo,d.Districts.features=$.grep(d.Districts.features,function(e){return null!==e.properties.pcode}),$scope.geom=d.Districts,d.Rapportage=[];for(var i=0;i<d.Districts.features.length;i++)d.Rapportage[i]=d.Districts.features[i].properties;if(d.dpi_temp=pgData.usp_data.dpi,d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata_full=pgData.usp_data.meta_indicators,d.Metadata=$.grep(d.Metadata_full,function(e){return("CRA"==e.view_code||"CRA,PI"==e.view_code)&&$scope.replace_null(e.country_code).indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}),d.Country_meta_full=pgData.usp_data.meta_country,d.Country_meta=$.grep(d.Country_meta_full,function(e){return e.country_code==$scope.country_code}),console.log(d),document.getElementsByClassName("sidebar-wrapper")[0].setAttribute("style",""),document.getElementById("mapPopup").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",document.getElementById("level2")&&document.getElementById("level2").setAttribute("class","btn btn-secondary"),document.getElementById("level3")&&document.getElementById("level3").setAttribute("class","btn btn-secondary"),$(".sidebar-wrapper").addClass("in"),$(document).ready(function(){$(window).width()<768&&$(".sidebar-wrapper").removeClass("in")});for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in");$(".view-buttons button.active").removeClass("active"),"map"==$scope.chart_show?$(".view-buttons button.btn-map-view").addClass("active"):$(".view-buttons button.btn-tabular").addClass("active"),$scope.generateCharts(d),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")}),$scope.complete(),0==$rootScope.loadCount&&"undefined"!=typeof L_PREFER_CANVAS&&($("#IEmodal").modal("show"),$rootScope.loadCount+=1)},$scope.reinitiate=function(d){$scope.start(),$("#row-chart-container").hide(),$("#map-chart").show(),$scope.chart_show="map",$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Data.get({adminLevel:$scope.data_input},function(pgData){$scope.reload_data(d,pgData)})},$scope.reload_data=function(d,pgData){d.Districts=pgData.usp_data.geo,$scope.geom=pgData.usp_data.geo,d.Rapportage=[];for(var i=0;i<d.Districts.features.length;i++)d.Rapportage[i]=d.Districts.features[i].properties;if(d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata=$.grep(d.Metadata_full,function(e){return("CRA"==e.view_code||"CRA,PI"==e.view_code)&&$scope.replace_null(e.country_code).indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}),$(".view-buttons button.active").removeClass("active"),$(".view-buttons button.btn-map-view").addClass("active"),$scope.reload=1,$scope.generateCharts(d),$scope.complete()},$scope.genLookup=function(field){var lookup={};return $scope.geom.features.forEach(function(e){lookup[e.properties[$scope.config.joinAttribute]]=String(e.properties[field])}),lookup},$scope.genLookup_meta=function(d,field){var lookup_meta={};return d.Metadata.forEach(function(e){lookup_meta[e.variable]=$scope.replace_null(String(e[field]))}),lookup_meta},$scope.genLookup_country_meta=function(d,field){var lookup_country_meta={};return d.Country_meta.forEach(function(e){lookup_country_meta[e.country_code]=String(e[field])}),lookup_country_meta},$scope.generateCharts=function(d){function addParameterToURL(view,country,admlevel,metric,parent_codes,chart_show){var _url=location.href;return _url=_url.split("?")[0],_url+=(_url.split("?")[1]?"&":"?")+"country="+country+"&admlevel="+admlevel+"&metric="+metric+"&parent_code="+parent_codes+"&view="+chart_show}function zoomToGeom(geom){var bounds=d3.geo.bounds(geom);map.fitBounds([[bounds[0][1],bounds[0][0]],[bounds[1][1],bounds[1][0]]])}dc.chartRegistry.clear(),void 0!==map&&map.remove(),void 0!==map2&&map2.remove();var mapChart=dc.leafletChoroplethChart("#map-chart"),rowChart=dc.rowChart("#row-chart"),country_name=$scope.genLookup_country_meta(d,"country_name"),country_zoom_min=($scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name"),$scope.genLookup_country_meta(d,"zoomlevel_min")),country_zoom_max=$scope.genLookup_country_meta(d,"zoomlevel_max"),country_default_metric=$scope.genLookup_country_meta(d,"default_metric"),country_status=$scope.genLookup_country_meta(d,"format")[$scope.country_code];if("template"==country_status)document.getElementById("status").style.visibility="visible",$scope.status_title="Template only",$scope.status_text="This dashboard is only a template with administrative boundaries and population data. It is yet to be filled with actual risk data";else if("basic"==country_status)document.getElementById("status").style.visibility="visible",$scope.status_title="Draft version",$scope.status_text="This dashboard is filled with a limited number of indicators only, which need to be checked in terms of quality and use. Not to be used for external sharing and/or drawing conclusions yet.";else if("all"==country_status){var dpi=d.dpi[0].dpi_score;dpi>.1?(document.getElementById("status").style.visibility="hidden",$scope.status_title="",$scope.status_text=""):(document.getElementById("status").style.visibility="visible",$scope.status_title="Needs data",$scope.status_text="The Data Preparedness Index of the risk framework for this administrative level falls below the threshold for meaningful interpretation. It needs either more, newer or better data sources. The indicators that are included (e.g. population, poverty) can still be used on their own.")}$scope.country_selection=country_name[$scope.country_code];var zoom_min=Number(country_zoom_min[$scope.country_code]),zoom_max=Number(country_zoom_max[$scope.country_code]);$scope.inform_admlevel=Number($scope.genLookup_country_meta(d,"inform_admlevel")[$scope.country_code]),$scope.directURLload||(""===$scope.metric?$scope.metric=country_default_metric[$scope.country_code]:"undefined"==typeof d.Rapportage[0][$scope.metric]&&($scope.metric="population")),$scope.admlevel===zoom_min&&($scope.name_selection=country_name[$scope.country_code]),zoom_max-zoom_min<2?document.getElementById("level3").style.visibility="hidden":document.getElementById("level3")&&(document.getElementById("level3").style.visibility="visible");var lookup=$scope.genLookup($scope.config.nameAttribute),meta_label=$scope.genLookup_meta(d,"label"),meta_format=$scope.genLookup_meta(d,"format"),meta_unit=$scope.genLookup_meta(d,"unit"),meta_icon=$scope.genLookup_meta(d,"icon_src"),meta_year=$scope.genLookup_meta(d,"year"),meta_source=$scope.genLookup_meta(d,"source_link"),meta_desc=$scope.genLookup_meta(d,"description"),meta_scorevar=$scope.genLookup_meta(d,"scorevar_name");$scope.metric_label=meta_label[$scope.metric],$scope.type_selection=$scope.admlevel==zoom_min?"Country":$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code],$scope.subtype_selection=$scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name")[$scope.country_code],$scope.levelB_selection_pre="all_no",1==zoom_min||"MWI"==$scope.country_code||"MOZ"==$scope.country_code?($("#level2").addClass("btn-zoomin"),$("#level3").addClass("btn-zoomin"),$scope.admlevel==zoom_min?($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]):$scope.admlevel<zoom_max&&$scope.parent_codes.length>0?($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes):$scope.admlevel<zoom_max&&0==$scope.parent_codes.length?($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]):$scope.admlevel==zoom_max&&0==$scope.parent_codes.length&&($scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]),$scope.admlevel<zoom_max?($scope.levelC_selection_pre=0==$scope.parent_codes.length?"all_yes":void 0,$scope.levelC_selection=0==$scope.parent_codes.length?$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code]:void 0,$scope.levelC_code=""):$scope.admlevel==zoom_max&&0==$scope.parent_codes.length?($scope.levelC_selection_pre=0==$scope.parent_codes.length?"all_yes":void 0,$scope.levelC_selection=0==$scope.parent_codes.length?$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code]:void 0,$scope.levelC_code=""):$scope.parent_codes.length>0&&($scope.levelC_selection=$scope.name_selection,$scope.levelC_code=$scope.parent_code)):($("#level2").removeClass("btn-zoomin"),$("#level3").removeClass("btn-zoomin"),$scope.admlevel==zoom_min?($scope.levelB_selection=void 0,$scope.levelB_codes=[]):$scope.admlevel<=zoom_max&&void 0==$scope.levelB_selection&&($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes),$scope.levelC_selection=$scope.admlevel<zoom_max?void 0:$scope.name_selection,$scope.levelC_code=$scope.admlevel<zoom_max?"":$scope.parent_code);var dec0Format=(d3.format(","),d3.format(",.0f")),dec2Format=(d3.format(",.1f"),d3.format(".2f")),percFormat=d3.format(",.2%"),currentFormat=function(value){return"decimal0"===meta_format[$scope.metric]?dec0Format(value):"decimal2"===meta_format[$scope.metric]?dec2Format(value):"percentage"===meta_format[$scope.metric]?percFormat(value):void 0};d.Metadata.sort(function(a,b){return a.order-b.order}),$scope.tables=[];for(var j=0,i=0;i<d.Metadata.length;i++){var record={},record_temp=d.Metadata[i];"admin"!==record_temp.group&&(record.id="data-table"+[i+1],record.name=record_temp.variable,record.group=record_temp.group,record.propertyPath="sum"===record_temp.agg_method?"value":"value.finalVal",record.dimension=void 0,record.weight_var=record_temp.weight_var,record.scorevar_name=record_temp.scorevar_name,record.view="CRA",$scope.tables[j]=record,j+=1)}var cf=crossfilter(d.Rapportage),whereDimension=cf.dimension(function(d){return d.pcode}),whereDimension_tab=cf.dimension(function(d){return d.pcode}),whereGroupSum=whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereGroupSum_lookup=(whereDimension_tab.group().reduceSum(function(d){return d[$scope.metric]}),whereDimension.group().reduce(function(p,v){return p.count=null!==v[$scope.metric]?p.count+1:p.count,p.sum=p.sum+v[$scope.metric],p},function(p,v){return p.count=null!==v[$scope.metric]?p.count-1:p.count,p.sum=p.sum-v[$scope.metric],p},function(){return{count:0,sum:0}}));$scope.genLookup_value=function(){var lookup_value={};return whereGroupSum_lookup.top(1/0).forEach(function(e){lookup_value[e.key]=0==e.value.count?"No data":e.value.sum}),lookup_value};var cf_scores_metric=meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric,whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var reduceAddAvg=function(metricA,metricB){return function(p,v){return p.count=null!==v[metricA]?p.count+1:p.count,p.sumOfSub+=v[metricA]*v[metricB],p.sumOfTotal+=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceRemoveAvg=function(metricA,metricB){return function(p,v){return p.count=null!==v[metricA]?p.count-1:p.count,p.sumOfSub-=v[metricA]*v[metricB],p.sumOfTotal-=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceInitialAvg=function(){return{count:0,sumOfSub:0,sumOfTotal:0,finalVal:0}},totaalDim=cf.dimension(function(i){return"Total"}),dimensions=[];$scope.tables.forEach(function(t){var name=t.name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions[name]=totaalDim.group().reduce(reduceAddAvg([name],[weight_var]),reduceRemoveAvg([name],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions[name]=totaalDim.group().reduceSum(function(d){return d[name]}))});var dimensions_scores=[];$scope.tables.forEach(function(t){var name=t.name;if(t.scorevar_name){var name_score=t.scorevar_name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions_scores[name]=totaalDim.group().reduce(reduceAddAvg([name_score],[weight_var]),reduceRemoveAvg([name_score],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions_scores[name]=totaalDim.group().reduceSum(function(d){return d[name_score]}))}});var i;for(i=0;i<$scope.tables.length;i++){var name=$scope.tables[i].name;$scope.tables[i].dimension=dimensions[name]}var fill_keyvalues=function(){var keyvalue=[];return $scope.tables.forEach(function(t){var key=t.name;"dpi"==t.group?keyvalue[key]=dec2Format(d.dpi[0][t.name]):$scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[t.name])?"value.finalVal"===t.propertyPath?isNaN(dimensions[t.name].top(1)[0].value.finalVal)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value.finalVal):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value.finalVal):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value.finalVal)):"value"===t.propertyPath&&(isNaN(dimensions[t.name].top(1)[0].value)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value))):"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(d_prev[t.name]):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(d_prev[t.name]):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(d_prev[t.name]))}),keyvalue},keyvalue=fill_keyvalues();if($scope.admlevel==zoom_min||$scope.directURLload){var quantile_range_scores=[],j=0;for(i=0;i<d.Rapportage.length;i++)Object.keys(d.Rapportage[i]).forEach(function(key,index){meta_scorevar[key]&&(d.Rapportage[i][meta_scorevar[key]]||0==d.Rapportage[i][meta_scorevar[key]])&&(quantile_range_scores[j]=d.Rapportage[i][meta_scorevar[key]],j+=1)});quantile_range_scores.sort(function(a,b){return a-b}),d.quantile_range_scores=quantile_range_scores;for(var quantile=function(values,p){var H=(values.length-1)*p+1,h=Math.floor(H),v=+values[h-1],e=H-h;return e?v+e*(values[h]-v):v},k=0,q=5,thresholds=[];++k<q;)thresholds[k-1]=Math.round(100*quantile(quantile_range_scores,k/q))/100;d.thresholds=thresholds}var high_med_low=function(ind,ind_score,group){if(dimensions_scores[ind]){if("dpi"==group)var width=10*(1-d.dpi[0][ind]);else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[ind_score]))if(0==dimensions_scores[ind].top(1)[0].value.count)var width="na";else var width=dimensions_scores[ind].top(1)[0].value.finalVal;else var width=d_prev[ind_score];if("dpi_score"==ind)return 1-width/10<.1?"bad":"good";if(isNaN(width))return"notavailable";if(width<d.thresholds[0])return"good";if(width<=d.thresholds[1])return"medium-good";if(width<=d.thresholds[2])return"medium";if(width<=d.thresholds[3])return"medium-bad";if(width>d.thresholds[3])return"bad"}};$scope.createHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));var general=document.getElementById("general"),dpi=document.getElementById("dpi"),scores=document.getElementById("scores"),vulnerability=document.getElementById("vulnerability"),hazard=document.getElementById("hazard"),coping=document.getElementById("coping_capacity"),other=document.getElementById("other");if(general)for(;general.firstChild;)general.removeChild(general.firstChild);if(dpi)for(;dpi.firstChild;)dpi.removeChild(dpi.firstChild);if(scores)for(;scores.firstChild;)scores.removeChild(scores.firstChild);if(vulnerability)for(;vulnerability.firstChild;)vulnerability.removeChild(vulnerability.firstChild);if(hazard)for(;hazard.firstChild;)hazard.removeChild(hazard.firstChild);if(coping)for(;coping.firstChild;)coping.removeChild(coping.firstChild);if(other)for(;other.firstChild;)other.removeChild(other.firstChild);for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if(meta_icon[record.name])var icon="modules/dashboards/img/"+meta_icon[record.name];else var icon="modules/dashboards/img/undefined.png";if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div=document.createElement("div");div.setAttribute("class","row profile-item"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col col-md-1 col-sm-1 col-xs-1"),div.appendChild(div0);var img=document.createElement("img");img.setAttribute("class","community-icon"),img.setAttribute("src",icon),div0.appendChild(img);var div1=document.createElement("div");div1.setAttribute("class","col col-md-5 col-sm-5 col-xs-5 general-component-label"),div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",div.appendChild(div1),$compile(div1)($scope);var div2=document.createElement("div");div2.setAttribute("class","col col-md-5 col-sm-5 col-xs-5"),div2.setAttribute("id",record.name),div2.innerHTML=keyvalue[record.name]+" "+unit,div.appendChild(div2);var div3=document.createElement("div");div3.setAttribute("class","col col-md-1 col-sm-1 col-xs-1"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img=document.createElement("img");img.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img.setAttribute("style","height:17px"),button.appendChild(img)}else if("other"===record.group){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div=document.createElement("div");div.setAttribute("class","component-section"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2 col-sm-2 col-xs-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-9 col-sm-9 col-xs-9 component-label"),div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div3=document.createElement("div");div3.setAttribute("class","col-md-1 col-sm-1 col-xs-1 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}else if("hide"!==record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div=document.createElement("div");div.setAttribute("class","component-section"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2 col-sm-2 col-xs-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-4 col-sm-4 col-xs-4 component-label"),"dpi"!==record.group&&div1.setAttribute("ng-click","change_indicator('"+record.name+"')"),div1.innerHTML="{{ '"+record.name+"' | translate }}",$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div2=document.createElement("div");div2.setAttribute("class","col-md-5 col-sm-5 col-xs-5"),div.appendChild(div2);var div2a=document.createElement("div");div2a.setAttribute("class","component-scale"),div2.appendChild(div2a);var div2a1=document.createElement("div");div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("id","bar-"+record.name),div2a1.setAttribute("style","width:"+width+"%"),div2a.appendChild(div2a1);var div3=document.createElement("div");div3.setAttribute("class","col-md-1 col-sm-1 col-xs-1 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}},$scope.createHTML(keyvalue);var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.add("section-active"),$scope.updateHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div2=document.getElementById(record.name);div2.innerHTML=keyvalue[record.name]+" "+unit}else if("other"===record.group){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.innerHTML=keyvalue[record.name]+" "+unit;
}}else if("hide"!==record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.innerHTML=keyvalue[record.name]+" "+unit;var div2a1=document.getElementById("bar-"+record.name);div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("style","width:"+width+"%")}}},$scope.mapchartColors=function(){var quantile_range=[];if(meta_scorevar[$scope.metric])quantile_range=d.quantile_range_scores;else{for(i=0;i<d.Rapportage.length;i++)d.Rapportage[i][$scope.metric]&&(quantile_range.push(d.Rapportage[i][$scope.metric]),quantile_range.sort(function(a,b){return a-b}));$scope.quantile_max=quantile_range[quantile_range.length-1]}var colorDomain;return colorDomain=meta_scorevar[$scope.metric]?$scope.quantileColorDomain_CRA_scores:$scope.quantileColorDomain_CRA_std,d3.scale.quantile().domain(quantile_range).range(colorDomain)};var mapchartColors=$scope.mapchartColors();$scope.coming_from_map=!1,$scope.coming_from_tab=!1,mapChart.width($("#map-chart").width()).height(800).dimension(whereDimension).group(whereGroupSum_scores).center([0,0]).zoom(0).geojson(d.Districts).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).featureKeyAccessor(function(feature){return feature.properties.pcode}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat($scope.genLookup_value()[d.key])):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).renderPopup(!0).turnOnControls(!0).legend(dc.leafletLegend().position("topright")).on("filtered",function(chart,filters,e){if($scope.filters=chart.filters(),"map"==$scope.chart_show&&$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("map"==$scope.chart_show&&!$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}var popup=document.getElementById("mapPopup");popup.style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.filters.length>mapfilters_length&&($scope.$apply(function(){$scope.name_popup=lookup[$scope.filters[$scope.filters.length-1]];for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[$scope.filters.length-1]){$scope.value_popup=currentFormat(record[$scope.metric]),$scope.value_popup_unit=$scope.replace_null(meta_unit[$scope.metric]);break}}$scope.metric_label=meta_label[$scope.metric]}),$(window).width()<768?(popup.style.left="5px",popup.style.bottom="8%"):"undefined"!=typeof event?(popup.style.left=Math.min($(window).width()-210,event.pageX)+"px",popup.style.top=Math.min($(window).height()-210,event.pageY)+"px"):(popup.style.left=$scope.posx+"px",popup.style.top=$scope.posy+"px"),popup.style.visibility="visible",$scope.admlevel<zoom_max&&"PI"!==$scope.view_code&&(document.getElementById("zoomin_icon").style.visibility="visible")),mapfilters_length=$scope.filters.length,document.getElementById("section-"+$scope.metric).classList.add("section-active")}),$scope.FF_mouse_coordinates=function(e){e=e||window.event,(e.pageX||e.pageY)&&($scope.posx=e.pageX,$scope.posy=e.pageY)};var mapElem=document.getElementById("map-chart");if(mapElem.addEventListener("click",$scope.FF_mouse_coordinates,!1),$(window).width()<768)var rowChart_width=$("#row-chart-container").width();else var rowChart_width=$("#row-chart-container").width()-370;var barheight=20,xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.width(rowChart_width).height((barheight+5)*d.Rapportage.length+50).dimension(whereDimension_tab).group(whereGroupSum_scores_tab).ordering(function(d){return isNaN($scope.genLookup_value()[d.key])?999999999-d.value.sum:-d.value.sum}).fixedBarHeight(barheight).valueAccessor(function(d){return isNaN(d.value.sum)?0:d.value.sum}).colors(mapchartColors).colorCalculator(function(d){return d.value.count?mapChart.colors()(d.value.sum):"#cccccc"}).label(function(d){return meta_scorevar[$scope.metric]?"No data"==$scope.genLookup_value()[d.key]?"No data - ".concat(lookup[d.key]):currentFormat($scope.genLookup_value()[d.key]).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).on("filtered",function(chart,filters){if($scope.filters=chart.filters(),"row"==$scope.chart_show&&$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("row"==$scope.chart_show&&!$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}}).elasticX(!1).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])).xAxis().scale(rowChart.x()).tickValues([]),$scope.row_text=function(color_range){for(var color_level,i=0;i<$(".dc-chart g.row").length;i++){if(row=$(".dc-chart g.row")[i],fill=row.getElementsByTagName("rect")[0].getAttribute("fill"),selection=row.getElementsByTagName("rect")[0].getAttribute("class"),fill)for(j=0;j<color_range.length;j++)if(fill.toString().toLowerCase()==color_range[j].HEX.toLowerCase()){color_level=j;break}title=row.getElementsByTagName("title")[0].innerHTML,title||(string=(new XMLSerializer).serializeToString(row.getElementsByTagName("title")[0]),pos=string.indexOf(">"),title=string.substring(pos+1,pos+4)),text=row.getElementsByTagName("text")[0],"deselected"==selection&&"No Data"==title.substring(0,7)?text.style.fill="white":color_level<=2||"deselected"==selection||!fill||parseInt(title.substring(0,3))<3?text.style.fill="black":text.style.fill="white"}},$scope.sort=function(type){"value"===type?rowChart.ordering(function(d){return isNaN(d.value.sum)?0:-d.value.sum}):"name"==type&&rowChart.ordering(function(d){return 0==d.value?"zzz":lookup[d.key]}),rowChart.redraw()},$scope.scrollRowChart=function(){$("#tabular-wrapper").scrollTop(0)},$scope.zoom_in=function(){if($scope.filters.length>0&&$scope.admlevel<zoom_max){if($scope.admlevel=$scope.admlevel+1,$scope.parent_code_prev=$scope.parent_code,$scope.name_selection_prev=$scope.name_selection,$scope.parent_codes=$scope.filters,$scope.name_selection=$scope.filters.length>1?"Multiple "+$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code]:lookup[$scope.parent_codes[0]],$scope.admlevel==zoom_max)for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[0]){d_prev=record;break}}$scope.filters=[],$scope.reinitiate(d),document.getElementById("level"+($scope.admlevel-zoom_min+1)).setAttribute("class","btn btn-secondary btn-active"),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",mapfilters_length=0}},$scope.zoom_out=function(dest_level){var admlevel_old=$scope.admlevel;for(1==zoom_min||"MWI"==$scope.country_code||"MOZ"==$scope.country_code?1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.levelB_selection_pre="all_yes",$scope.levelB_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel>zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.levelC_selection_pre="all_yes",$scope.levelC_selection=$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel<zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=[],$scope.name_selection=$scope.levelB_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),$scope.reinitiate(d)):3===dest_level&&$scope.admlevel<zoom_min+2&&0==$scope.parent_codes.length&&($scope.admlevel=zoom_min+2,$scope.parent_codes=[],$scope.name_selection=$scope.levelC_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),document.getElementById("level3").setAttribute("class","btn btn-secondary btn-active"),$scope.reinitiate(d)):1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.reinitiate(d)):2===dest_level&&$scope.admlevel>zoom_min+1&&($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.reinitiate(d));admlevel_old-zoom_min>dest_level-1;)document.getElementById("level"+(admlevel_old-zoom_min+1)).setAttribute("class","btn btn-secondary"),admlevel_old-=1;document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.mapShow()},$scope.change_indicator=function(id){var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.remove("section-active"),$scope.metric=id,$scope.metric_label=meta_label[id];var mapchartColors=$scope.mapchartColors();cf_scores_metric=meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric,whereGroupSum.dispose(),whereGroupSum=whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereGroupSum_lookup.dispose(),whereGroupSum_lookup=whereDimension.group().reduce(function(p,v){return p.count=null!==v[$scope.metric]?p.count+1:p.count,p.sum=p.sum+v[$scope.metric],p},function(p,v){return p.count=null!==v[$scope.metric]?p.count-1:p.count,p.sum=p.sum-v[$scope.metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores.dispose(),whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores_tab.dispose(),whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),mapChart.group(whereGroupSum_scores).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat($scope.genLookup_value()[d.key])):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])});var xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.group(whereGroupSum_scores_tab).ordering(function(d){return isNaN($scope.genLookup_value()[d.key])?999999999:-d.value.sum}).valueAccessor(function(d){return isNaN($scope.genLookup_value()[d.key])?"":d.value.sum}).colors(mapchartColors).colorCalculator(function(d){return d.value.count?mapChart.colors()(d.value.sum):"#cccccc"}).label(function(d){return meta_scorevar[$scope.metric]?"No data"==$scope.genLookup_value()[d.key]?"No data - ".concat(lookup[d.key]):currentFormat($scope.genLookup_value()[d.key]).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])),$("#map-chart2").hide(),$("#map-chart").show(),dc.redrawAll(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("section-"+id).classList.add("section-active")},$scope.info=function(id){$scope.metric_info=id,"admin"!==id&&($scope.metric_label=meta_label[id]),$scope.metric_label_popup=meta_label[id],$scope.metric_year=meta_year[id],$scope.metric_source=meta_source[id],$scope.metric_desc=meta_desc[id],meta_icon[id]?$scope.metric_icon="modules/dashboards/img/"+meta_icon[id]:$scope.metric_icon="modules/dashboards/img/undefined.png",$("#infoModal").modal("show")};for(var acc=document.getElementsByClassName("card-header level1"),active=(document.getElementsByClassName("collapse level1"),document.getElementsByClassName("collapse level1 in")[0]),i=0;i<acc.length;i++)acc[i].onclick=function(){var active_new=document.getElementById(this.id.replace("heading","collapse"));active.id!==active_new.id&&active.classList.remove("in"),active=active_new};$scope.open_status=function(){$("#statusModal").modal("show")},$scope.open_DPI=function(){$("#statusModal").modal("hide"),$(".collapse.level1.in").removeClass("in"),$("#collapseZero").addClass("in"),setTimeout(function(){$("#dpi-card").addClass("dpi-card-highlight")},100),setTimeout(function(){$(" #dpi-card").removeClass("dpi-card-highlight")},1e3)},$scope.export_geojson=function(){var myWindow=window.open("","","_blank");myWindow.document.write(JSON.stringify(d.Districts)),myWindow.focus()},$scope.export_csv=function(){for(var content=d.Rapportage,finalVal="",i=0;i<content.length;i++){var key,innerValue,result,value=content[i];if(0===i){for(key in value)value.hasOwnProperty(key)&&(innerValue=meta_label[key]?meta_label[key]:meta_label[key.replace("_score","")]?meta_label[key.replace("_score","")]+" (0-10)":key,result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}for(key in value)value.hasOwnProperty(key)&&(innerValue=JSON.stringify(value[key]),result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}var download=document.getElementById("download");download.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(finalVal)),download.setAttribute("download","export.csv")},$scope.share_URL=function(){$scope.shareable_URL=addParameterToURL($scope.view_code,$scope.country_code,$scope.admlevel,$scope.metric,$scope.parent_codes,$scope.chart_show),$("#URLModal").modal("show")},$scope.share_country_URL=function(){$scope.shareable_URL=location.href+"?country="+$scope.country_code,$("#URLModal").modal("show")},$scope.copyToClipboard=function(element){var $temp=$("<input>");$("body").append($temp),$temp.val($(element).text()).select(),document.execCommand("copy"),$temp.remove()},$scope.tutorial=function(){($scope.view_code="PI")?window.open("#!/#walkthrough_PI","_blank"):window.open("#!/#walkthrough","_blank")},$scope.data_upload=function(){$("#uploadModal").modal("show")},$(document).ready(function(){function browserSupportFileUpload(){var isCompatible=!1;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(isCompatible=!0),isCompatible}function upload(evt){if(browserSupportFileUpload()){var file=evt.target.files[0],reader=new FileReader;reader.readAsText(file),reader.onload=function(event){$scope.csvData=event.target.result},reader.onerror=function(){alert("Unable to read "+file.fileName)}}else alert("The File APIs are not fully supported in this browser!")}document.getElementById("txtFileUpload").addEventListener("change",upload,!1)}),$scope.submit_data=function(){for(var separator=$("#separator").val(),data=$.csv.toArrays($scope.csvData,{separator:separator}),pcode_check=0,pcode_col=0,i=0;i<data[0].length;i++)if("pcode"==data[0][i].toLowerCase()){data[0][i]=data[0][i].toLowerCase(),pcode_col=i,pcode_check=1;break}if(0==pcode_check)$scope.data_upload_warning="No column named 'pcode' is found. Please change the input-file accordingly. Note that a reason for this can also be that the field-separator is not correct.",$("#uploadWarningModal").modal("show");else{for(var counts=[],pcode_dup_check=0,j=0;j<data.length;j++){if(void 0!==counts[data[j][pcode_col]]){pcode_dup_check=1;break}counts[data[j][pcode_col]]=1}1==pcode_dup_check&&($scope.data_upload_warning="Duplicate values are found in pcode-column. Please change the input-file accordingly.",$("#uploadWarningModal").modal("show"))}},$scope.mapShow=function(){if(0==$scope.filters.length)zoomToGeom($scope.geom);else{$scope.districts_temp=JSON.parse(JSON.stringify($scope.geom)),$scope.districts_temp.features=[];for(var i=0;i<$scope.geom.features.length;i++)$scope.filters.indexOf($scope.geom.features[i].properties.pcode)>-1&&$scope.districts_temp.features.push($scope.geom.features[i]);zoomToGeom($scope.districts_temp)}"row"==$scope.chart_show&&($scope.chart_show="map",$("#row-chart-container").hide(),$("#map-chart").show(),$scope.click_filter=!1,$scope.coming_from_tab=!0,rowChart.filter(null),$scope.click_filter=!0,$scope.coming_from_tab=!1),$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$scope.tabularShow=function(){$scope.chart_show="row",$("#map-chart").hide(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("row-chart-container").style.visibility="visible",$("#row-chart-container").show(),$scope.click_filter=!1,$scope.coming_from_map=!0,mapChart.filter(null),$scope.click_filter=!0,$scope.coming_from_map=!1,$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$(".view-buttons button").click(function(e){$(".view-buttons button.active").removeClass("active");var $this=$(this);$this.hasClass("active")||$this.addClass("active"),e.preventDefault()}),$scope.reset_function=function(){dc.filterAll(),dc.redrawAll();var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue),"map"==$scope.chart_show&&zoomToGeom($scope.geom)},dc.renderAll(),$("#dpi-card").hide(),map=mapChart.map(),zoomToGeom($scope.geom);var prev_indicator="";$scope.change_raster=function(indicator){if(indicator==prev_indicator)$("#map-chart").hide(),$("#map-chart2").show();else{$scope.start(),void 0!==map2&&map2.remove(),map2=L.map("map-chart2"),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map2);var url="modules/dashboards/data/ZMB_births_pp_v2_2015.tif";fetch(url).then(function(r){return r.arrayBuffer()}).then(function(buffer){var s=L.ScalarField.fromGeoTIFF(buffer),layer=L.canvasLayer.scalarField(s,{color:chroma.scale("RdPu").domain([s.range[0],s.range[1]/100]),opacity:.65}).addTo(map2);map2.fitBounds(layer.getBounds())}),$scope.complete(),$("#map-chart").hide(),prev_indicator=indicator}},"map"==$scope.chart_show?$("#row-chart-container").hide():"row"==$scope.chart_show&&$scope.tabularShow();var zoom_child=$(".leaflet-control-zoom")[0],zoom_parent=$(".leaflet-bottom.leaflet-right")[0];zoom_parent.insertBefore(zoom_child,zoom_parent.childNodes[0]),$scope.changeLanguage=function(langKey){$translate.use(langKey),$scope.language=langKey;for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in")};var languages_es=["PER","ECU"],languages_fr=[],languages_all=[].concat(languages_es,languages_fr);languages_all.indexOf($scope.country_code)>-1?(document.getElementById("language-selector").style.display="block",1==$scope.reload&&"en"==$scope.language?$scope.changeLanguage("en"):languages_fr.indexOf($scope.country_code)>-1?($scope.changeLanguage("fr"),document.getElementById("language-selector-es").style.display="none",document.getElementById("language-selector-fr").style.display="block"):languages_es.indexOf($scope.country_code)>-1&&($scope.changeLanguage("es"),document.getElementById("language-selector-es").style.display="block",document.getElementById("language-selector-fr").style.display="none")):(document.getElementById("language-selector").style.display="none",$scope.changeLanguage("en")),$scope.translateData=function(){return{metric_label:$scope.metric,metric_label_popup:$scope.metric_info,metric_desc:"desc_"+$scope.metric_info,subtype_selection:$scope.subtype_selection,levelB_selection_pre:$scope.levelB_selection_pre,levelC_selection_pre:$scope.levelC_selection_pre}}}}]),angular.module("dashboards").controller("PriorityIndexController",["$translate","$scope","$css","$rootScope","$compile","$q","Authentication","Data","$window","$stateParams","cfpLoadingBar",function($translate,$scope,$css,$rootScope,$compile,$q,Authentication,Data,$window,$stateParams,cfpLoadingBar){$css.remove(["modules/dashboards/css/core.css"]),$css.add(["modules/dashboards/css/header.css","modules/dashboards/css/dashboards.css"]),$scope.change_view=function(view){$rootScope.view_code=view},$scope.set_defaults_country=function(country){$scope.country_code=country,"PHL"==country?$scope.disaster_type="Typhoon":"NPL"==country?$scope.disaster_type="Earthquake":"ECU"!=country&&"PER"!=country||($scope.disaster_type="Flood"),"PHL"==country?$scope.disaster_name="Haima":"NPL"==country?$scope.disaster_name="Ghorka 2015":"ECU"!=country&&"PER"!=country||($scope.disaster_name="Total")},$scope.change_country=function(country){$scope.set_defaults_country(country),$scope.parent_codes=[],$scope.metric="",$scope.initiate($rootScope.view_code)},$scope.change_disaster_type=function(disaster_type){$scope.disaster_type=disaster_type,"PHL"==$scope.country_code?$scope.disaster_name="Typhoon"==$scope.disaster_type?"Haima":"Batangas 2017":"NPL"==$scope.country_code?$scope.disaster_name="Ghorka 2015":"ECU"!=$scope.country_code&&"PER"!=$scope.country_code||($scope.disaster_name="Total"),$scope.initiate("PI")},$scope.change_disaster=function(disaster_name){$scope.disaster_name=disaster_name,console.log($scope.disaster_name),$scope.initiate("PI")},$rootScope.loadCount=0,$scope.reload=0,$scope.authentication=Authentication,$scope.geom=null,$scope.view_code="PI",$scope.country_code="PHL",$rootScope.country_code&&($scope.country_code=$rootScope.country_code),"PHL"==$scope.country_code?$scope.disaster_type="Typhoon":"NPL"==$scope.country_code?$scope.disaster_type="Earthquake":"ECU"!=$scope.country_code&&"PER"!=$scope.country_code||($scope.disaster_type="Flood"),"PHL"==$scope.country_code?$scope.disaster_name="Typhoon"==$scope.disaster_type?"Haima":"Batangas 2017":"NPL"==$scope.country_code?$scope.disaster_name="Ghorka 2015":"ECU"!=$scope.country_code&&"PER"!=$scope.country_code||($scope.disaster_name="Total"),$scope.metric="",$rootScope.disaster_type&&($scope.disaster_type=$rootScope.disaster_type),$rootScope.view_code&&($scope.view_code=$rootScope.view_code),["PHL","NPL","ECU","PER"].indexOf($scope.country_code)<=-1&&($scope.country_code="PHL"),$scope.admlevel=3,$scope.metric_label="",$scope.metric_year="",$scope.metric_source="",$scope.metric_desc="",$scope.metric_icon="",$scope.admlevel_text="",$scope.name_selection="",$scope.name_selection_prev="",$scope.name_popup="",$scope.value_popup=0,$scope.country_selection="",$scope.parent_codes=[],$scope.data_input="",$scope.filters=[],$scope.tables=[],$scope.x=500,$scope.y=200,$scope.quantileColorDomain_PI_std=["#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"],$scope.quantileColorDomain_PI_error=["#d7191c","#fdae61","#ffffbf","#DA70D6","#8B008B"],$scope.quantileColorDomain_CRA_std=["#f1eef6","#bdc9e1","#74a9cf","#2b8cbe","#045a8d"];var map,mapfilters_length=0,d_prev="";$scope.config={whereFieldName:"pcode",joinAttribute:"pcode",nameAttribute:"name",color:"#0080ff"},$scope.start=function(){cfpLoadingBar.start()},$scope.complete=function(){cfpLoadingBar.complete()},$scope.replace_null=function(value){return null!=value&&"null"!=value&&value?value:""},$scope.initiate=function(view_code){$scope.start(),$("#row-chart-container").hide(),$("#map-chart").show(),$scope.chart_show="map";var url=location.href;$scope.view_code_PI=url.indexOf("priority_index")>-1?"PI":"DDB","PI"==$scope.view_code_PI&&0==$scope.reload&&("Typhoon"==$scope.disaster_type?$scope.disaster_name="Mangkhut":$scope.disaster_name="Leyte 2017"),url.indexOf("?")>-1?(url=url.split("?")[1],$scope.country_code=url.split("&")[0].split("=")[1],url.split("&")[1]?($scope.directURLload=!0,$scope.country_code=url.split("&")[0].split("=")[1],$scope.admlevel=url.split("&")[1].split("=")[1],$scope.metric=url.split("&")[2].split("=")[1],$scope.chart_show=url.split("&")[5].split("=")[1],$scope.disaster_type=url.split("&")[3].split("=")[1],$scope.disaster_name=url.split("&")[4].split("=")[1].replace("%20"," ")):($scope.directURLload=!1,$scope.set_defaults_country($scope.country_code)),window.history.pushState({},document.title,"PI"==$scope.view_code_PI?"/#!/priority_index":"/#!/impact_database")):$scope.directURLload=!1,$scope.admlevel=3,""==$scope.disaster_name&&($scope.disaster_name="Typhoon"==$scope.disaster_type?"Haima":"Batangas 2017"),["PHL","NPL","ECU","PER"].indexOf($scope.country_code)<=-1?$scope.country_code="PHL":"PI"==$scope.view_code&&"NPL"==$scope.country_code&&($scope.admlevel=4,$scope.disaster_type="Earthquake",$scope.disaster_name="Gorkha 2015"),$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",console.log($scope.data_input),Data.get({adminLevel:$scope.data_input},function(pgData){$scope.load_data(pgData)})},$scope.load_data=function(pgData){var d={};d.Rapportage=pgData.usp_data.ind;for(var pcode_list=[],i=0;i<d.Rapportage.length;i++)pcode_list[i]=d.Rapportage[i].pcode;d.Districts=pgData.usp_data.geo,d.Districts.features=$.grep(d.Districts.features,function(e){return pcode_list.indexOf(e.properties.pcode)>-1}),$scope.geom=d.Districts,d.Metadata_full=pgData.usp_data.meta_indicators,d.Metadata=$.grep(d.Metadata_full,function(e){return(("PI"==e.view_code||"CRA,PI"==e.view_code)&&$scope.replace_null(e.disaster_type).indexOf($scope.disaster_type)>-1||$scope.replace_null(e.view_code).indexOf("PI")>-1&&""==$scope.replace_null(e.disaster_type))&&$scope.replace_null(e.country_code).indexOf($scope.country_code)>-1}),d.Country_meta_full=pgData.usp_data.meta_country,d.Country_meta=$.grep(d.Country_meta_full,function(e){return e.country_code==$scope.country_code}),d.Disaster_meta_full=pgData.usp_data.meta_disaster,d.Disaster_meta=$.grep(d.Disaster_meta_full,function(e){return e.disaster_type==$scope.disaster_type&&e.country_code==$scope.country_code}),console.log(d),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("level2")&&document.getElementById("level2").setAttribute("class","btn btn-secondary"),document.getElementById("level3")&&document.getElementById("level3").setAttribute("class","btn btn-secondary"),document.getElementsByClassName("sidebar-wrapper")[0].setAttribute("style",""),document.getElementsByClassName("reset-button")[0].style.visibility="hidden",$(".sidebar-wrapper").addClass("in"),$(document).ready(function(){$(window).width()<768&&$(".sidebar-wrapper").removeClass("in")});for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in");$(".view-buttons button.active").removeClass("active"),"map"==$scope.chart_show?$(".view-buttons button.btn-map-view").addClass("active"):$(".view-buttons button.btn-tabular").addClass("active"),$scope.generateCharts(d),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")}),$scope.complete(),0==$rootScope.loadCount&&"undefined"!=typeof L_PREFER_CANVAS&&($("#IEmodal").modal("show"),$rootScope.loadCount+=1)},$scope.genLookup=function(field){var lookup={};return $scope.geom.features.forEach(function(e){lookup[e.properties[$scope.config.joinAttribute]]=String(e.properties[field])}),lookup},$scope.genLookup_meta=function(d,field){var lookup_meta={};return d.Metadata.forEach(function(e){lookup_meta[e.variable]=$scope.replace_null(String(e[field]))}),lookup_meta},$scope.genLookup_country_meta=function(d,field){var lookup_country_meta={};return d.Country_meta_full.forEach(function(e){lookup_country_meta[e.country_code]=String(e[field])}),lookup_country_meta},$scope.genLookup_disaster_meta=function(d,field){var lookup_disaster_meta={};return d.Disaster_meta.forEach(function(e){lookup_disaster_meta[e.name]=String(e[field])}),lookup_disaster_meta},$scope.generateCharts=function(d){function addParameterToURL(view,country,admlevel,metric,parent_codes,disaster_type,disaster_name,chart_show){var _url=location.href;return _url=_url.split("?")[0],_url+=(_url.split("?")[1]?"&":"?")+"country="+country+"&admlevel="+admlevel+"&metric="+metric+"&disaster="+disaster_type+"&event="+disaster_name+"&view="+chart_show}function zoomToGeom(geom){var bounds=d3.geo.bounds(geom);map.fitBounds([[bounds[0][1],bounds[0][0]],[bounds[1][1],bounds[1][0]]])}dc.chartRegistry.clear(),void 0!==map&&map.remove();var mapChart=dc.leafletChoroplethChart("#map-chart"),rowChart=dc.rowChart("#row-chart"),country_name=$scope.genLookup_country_meta(d,"country_name"),country_zoom_min=($scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name"),$scope.genLookup_country_meta(d,"zoomlevel_min")),country_zoom_max=$scope.genLookup_country_meta(d,"zoomlevel_max");$scope.genLookup_country_meta(d,"default_metric"),$scope.country_selection=country_name[$scope.country_code];var zoom_min=Number(country_zoom_min[$scope.country_code]),zoom_max=Number(country_zoom_max[$scope.country_code]);$scope.inform_admlevel=Number($scope.genLookup_country_meta(d,"inform_admlevel")[$scope.country_code]),$scope.directURLload||("PI"==$scope.view_code_PI?$scope.metric="pred_damage_class":$scope.metric=$scope.genLookup_disaster_meta(d,"default_metric")[$scope.disaster_name]),$scope.default_metric=$scope.genLookup_disaster_meta(d,"default_metric")[$scope.disaster_name],$scope.default_metric_label=$scope.default_metric.replace("_"," "),$scope.admlevel===zoom_min&&($scope.name_selection=country_name[$scope.country_code]);var lookup=$scope.genLookup($scope.config.nameAttribute),meta_label=$scope.genLookup_meta(d,"label"),meta_format=$scope.genLookup_meta(d,"format"),meta_unit=$scope.genLookup_meta(d,"unit"),meta_icon=$scope.genLookup_meta(d,"icon_src"),meta_year=$scope.genLookup_meta(d,"year"),meta_source=$scope.genLookup_meta(d,"source_link"),meta_desc=$scope.genLookup_meta(d,"description"),meta_scorevar=$scope.genLookup_meta(d,"scorevar_name");$scope.metric_label=meta_label[$scope.metric],$scope.type_selection=$scope.admlevel==zoom_min?"Country":$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code],
$scope.subtype_selection=$scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name")[$scope.country_code];var dec0Format=(d3.format(","),d3.format(",.0f")),dec2Format=(d3.format(",.1f"),d3.format(".2f")),percFormat=d3.format(",.2%"),currentFormat=function(value){return"decimal0"===meta_format[$scope.metric]?dec0Format(value):"decimal2"===meta_format[$scope.metric]?dec2Format(value):"percentage"===meta_format[$scope.metric]?percFormat(value):void 0};$scope.tables=[];for(var j=0,i=0;i<d.Metadata.length;i++){var record={},record_temp=d.Metadata[i];"admin"!==record_temp.group&&(record.id="data-table"+[i+1],record.name=record_temp.variable,record.group=["vulnerability","coping_capacity","general","other"].indexOf(record_temp.group)>-1?"cra_features":record_temp.group,record.propertyPath="sum"===record_temp.agg_method?"value":"value.finalVal",record.dimension=void 0,record.weight_var=record_temp.weight_var,record.scorevar_name="",record.view="PI",$scope.tables[j]=record,j+=1)}var cf=crossfilter(d.Rapportage),whereDimension=cf.dimension(function(d){return d.pcode}),whereDimension_tab=cf.dimension(function(d){return d.pcode}),cf_scores_metric=(whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereDimension_tab.group().reduceSum(function(d){return d[$scope.metric]}),$scope.metric),whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),cf_scores_metric=$scope.metric,whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var reduceAddAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub+=v[metricA]*v[metricB],p.sumOfTotal+=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceRemoveAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub-=v[metricA]*v[metricB],p.sumOfTotal-=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceInitialAvg=function(){return{sumOfSub:0,sumOfTotal:0,finalVal:0}},totaalDim=cf.dimension(function(i){return"Total"}),dimensions=[];$scope.tables.forEach(function(t){var name=t.name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions[name]=totaalDim.group().reduce(reduceAddAvg([name],[weight_var]),reduceRemoveAvg([name],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions[name]=totaalDim.group().reduceSum(function(d){return d[name]}))});var i;for(i=0;i<$scope.tables.length;i++){var name=$scope.tables[i].name;$scope.tables[i].dimension=dimensions[name]}if($scope.actuals=$scope.genLookup_disaster_meta(d,"actuals")[$scope.disaster_name],$scope.predictions=$scope.genLookup_disaster_meta(d,"predictions")[$scope.disaster_name],$scope.metric_label=meta_label[$scope.metric],"yes"==$scope.actuals&&"no"==$scope.predictions?$scope.type_text="This historical "+$scope.disaster_type.toLowerCase()+" was used to develop this model, but was never used to make predictions at the time.":"yes"==$scope.actuals&&"yes"==$scope.predictions?$scope.type_text="For this "+$scope.disaster_type.toLowerCase()+", priority areas were predicted using the model, and actual damage was collected later, so prediction errors can be measured.":"no"==$scope.actuals&&"yes"==$scope.predictions&&($scope.type_text="For this "+$scope.disaster_type.toLowerCase()+", priority areas were predicted using the model, but actual damage is not yet collected, so prediction errors cannot be measured yet."),$scope.start_date=$scope.genLookup_disaster_meta(d,"startdate")[$scope.disaster_name],$scope.end_date="Typhoon"==$scope.disaster_type?"to "+$scope.genLookup_disaster_meta(d,"enddate")[$scope.disaster_name]:"","DDB"==$scope.view_code_PI){var total_damage_temp=dimensions[$scope.default_metric].top(1)[0].value>0?dimensions[$scope.default_metric].top(1)[0].value:0;$scope.total_damage=dec0Format(total_damage_temp),$scope.total_potential=dec0Format(dimensions[$scope.default_metric.concat("_potential")].top(1)[0].value);var total_intensity=total_damage_temp/dimensions[$scope.default_metric.concat("_potential")].top(1)[0].value;isNaN(total_intensity)?$scope.total_intensity=percFormat(0):$scope.total_intensity=percFormat(total_intensity)}else{var total_damage_temp=0;$scope.total_damage=dec0Format(total_damage_temp),$scope.total_potential=1;var total_intensity=total_damage_temp/1;isNaN(total_intensity)?$scope.total_intensity=percFormat(0):$scope.total_intensity=percFormat(total_intensity)}for(var events=document.getElementById("events"),drop_events=document.getElementsByClassName("event-drop");drop_events[0];)drop_events[0].parentNode.removeChild(drop_events[0]);for(i=0;i<d.Disaster_meta.length;i++)if(record=d.Disaster_meta[i],record.disaster_type==$scope.disaster_type&&("DDB"==$scope.view_code_PI&&"yes"==record.actuals||"PI"==$scope.view_code_PI&&"yes"==record.predictions)){"yes"==record.actuals&&"no"==record.predictions||"yes"==record.actuals&&"yes"==record.predictions||"no"==record.actuals&&"yes"==record.predictions;var li=document.createElement("li");events.appendChild(li);var a=document.createElement("a");if(a.setAttribute("ng-click","change_disaster('"+record.name+"')"),a.setAttribute("class","event-drop"),record.startdate){var len=record.startdate.length;a.innerHTML=record.name+" ("+record.startdate.substr(len-4,len)+")"}else a.innerHTML=record.name;li.appendChild(a),$compile(a)($scope)}var fill_keyvalues=function(){var keyvalue=[];return $scope.tables.forEach(function(t){var key=t.name;$scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[t.name])?"value.finalVal"===t.propertyPath?isNaN(dimensions[t.name].top(1)[0].value.finalVal)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value.finalVal):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value.finalVal):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value.finalVal)):"value"===t.propertyPath&&(isNaN(dimensions[t.name].top(1)[0].value)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value))):"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(d_prev[t.name]):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(d_prev[t.name]):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(d_prev[t.name]))}),keyvalue},keyvalue=fill_keyvalues();$scope.createHTML=function(keyvalue){var predictions=document.getElementById("predictions"),damage=document.getElementById("damage"),pred_error=document.getElementById("pred_error"),disaster=document.getElementById("disaster"),geographic=document.getElementById("geographic"),cra_features=document.getElementById("cra_features");if(predictions)for(;predictions.firstChild;)predictions.removeChild(predictions.firstChild);if(damage)for(;damage.firstChild;)damage.removeChild(damage.firstChild);if(pred_error)for(;pred_error.firstChild;)pred_error.removeChild(pred_error.firstChild);if(disaster)for(;disaster.firstChild;)disaster.removeChild(disaster.firstChild);if(geographic)for(;geographic.firstChild;)geographic.removeChild(geographic.firstChild);if(cra_features)for(;cra_features.firstChild;)cra_features.removeChild(cra_features.firstChild);for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if(meta_icon[record.name])var icon="modules/dashboards/img/"+meta_icon[record.name];else var icon="modules/dashboards/img/undefined.png";if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("hide"!==record.group&&document.getElementById(record.group)&&(10*dimensions[record.name].top(1)[0].value.finalVal,("no"!=$scope.predictions||"predictions"!=record.group)&&("no"!=$scope.actuals||"damage"!=record.group)&&("no"!=$scope.predictions&&"no"!=$scope.actuals||"pred_error"!=record.group)||"cra_features"==record.group)){var div=document.createElement("div");div.setAttribute("class","component-section"),div.setAttribute("id","section-"+record.name);var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2 col-sm-2 col-xs-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-9 col-sm-9 col-xs-9 component-label"),div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div3=document.createElement("div");div3.setAttribute("class","col-md-1 col-sm-1 col-xs-1 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}},$scope.createHTML(keyvalue);var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.add("section-active"),$scope.updateHTML=function(keyvalue){for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("hide"!==record.group&&document.getElementById(record.group)&&(10*dimensions[record.name].top(1)[0].value.finalVal,("no"!=$scope.predictions||"predictions"!=record.group)&&("no"!=$scope.actuals||"damage"!=record.group)&&("no"!=$scope.predictions&&"no"!=$scope.actuals||"pred_error"!=record.group)||"cra_features"==record.group)){var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "),div1a.innerHTML=keyvalue[record.name]+" "+unit}}},$scope.mapchartColors=function(){var quantile_range=[];for(i=0;i<d.Rapportage.length;i++)quantile_range[i]=d.Rapportage[i][$scope.metric],quantile_range.sort(function(a,b){return a-b});$scope.quantile_max=quantile_range[quantile_range.length-1];var colorDomain;return colorDomain="pred_error"==$scope.genLookup_meta(d,"group")[$scope.metric]?$scope.quantileColorDomain_PI_error:"CRA,PI"==$scope.genLookup_meta(d,"view_code")[$scope.metric]?$scope.quantileColorDomain_CRA_std:$scope.quantileColorDomain_PI_std,d3.scale.quantile().domain(quantile_range).range(colorDomain)};var mapchartColors=$scope.mapchartColors();if(mapChart.width($("#map-chart").width()).height(800).dimension(whereDimension).group(whereGroupSum_scores).center([0,0]).zoom(0).geojson(d.Districts).colors(mapchartColors).colorCalculator(function(d){if($scope.metric.indexOf("damage_class")>-1){var colors=$scope.quantileColorDomain_PI_std;if(1==d.sum)return colors[0];if(2==d.sum)return colors[1];if(3==d.sum)return colors[2];if(4==d.sum)return colors[3];if(5==d.sum)return colors[4]}else{if("pred_error_damage"!=$scope.metric)return d.count?mapChart.colors()(d.sum):"#cccccc";var colors=$scope.quantileColorDomain_PI_error;if(!d.count)return"#cccccc";if(d.sum<=-3)return colors[0];if(d.sum==-2)return colors[1];if(Math.abs(d.sum)<=1)return colors[2];if(2==d.sum)return colors[3];if(d.sum>=3)return colors[4]}}).featureKeyAccessor(function(feature){return feature.properties.pcode}).popup(function(d){return lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).renderPopup(!0).turnOnControls(!0).legend(dc.leafletLegend().position("topright")).on("filtered",function(chart,filters){if($scope.filters=chart.filters(),"map"==$scope.chart_show&&$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("map"==$scope.chart_show&&!$scope.coming_from_tab){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}var popup=document.getElementById("mapPopup");popup.style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.filters.length>mapfilters_length&&($scope.$apply(function(){$scope.name_popup=lookup[$scope.filters[$scope.filters.length-1]];for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[$scope.filters.length-1]){$scope.value_popup=currentFormat(record[$scope.metric]),$scope.value_popup_unit=meta_unit[$scope.metric];break}}$scope.metric_label=meta_label[$scope.metric]}),$(window).width()<768?(popup.style.left="5px",popup.style.bottom="8%"):"undefined"!=typeof event?(popup.style.left=Math.min($(window).width()-210,event.pageX)+"px",popup.style.top=Math.min($(window).height()-210,event.pageY)+"px"):(popup.style.left="390px",popup.style.top="110px"),popup.style.visibility="visible",$scope.admlevel<zoom_max&&"PI"!==$scope.view_code&&(document.getElementById("zoomin_icon").style.visibility="visible")),mapfilters_length=$scope.filters.length,document.getElementById("section-"+$scope.metric).classList.add("section-active")}),$(window).width()<768)var rowChart_width=$("#row-chart-container").width();else var rowChart_width=$("#row-chart-container").width()-370;var barheight=20,xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.width(rowChart_width).height((barheight+5)*d.Rapportage.length+50).dimension(whereDimension_tab).group(whereGroupSum_scores_tab).ordering(function(d){return isNaN(d.value.sum)?0:-d.value.sum}).fixedBarHeight(barheight).valueAccessor(function(d){return isNaN(d.value.sum)?0:d.value.sum}).colors(mapchartColors).colorCalculator(function(d){if($scope.metric.indexOf("damage_class")>-1){var colors=$scope.quantileColorDomain_PI_std;if(1==d.value.sum)return colors[0];if(2==d.value.sum)return colors[1];if(3==d.value.sum)return colors[2];if(4==d.value.sum)return colors[3];if(5==d.value.sum)return colors[4]}else{if("pred_error_damage"!=$scope.metric)return d.value.count?mapChart.colors()(d.value.sum):"#cccccc";var colors=$scope.quantileColorDomain_PI_error;if(!d.value.count)return"#cccccc";if(d.value.sum<=-3)return colors[0];if(d.value.sum==-2)return colors[1];if(Math.abs(d.value.sum)<=1)return colors[2];if(2==d.value.sum)return colors[3];if(d.value.sum>=3)return colors[4]}}).label(function(d){return meta_scorevar[$scope.metric]?dec2Format(d.value.sum).concat(" / 10 - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):$scope.replace_null(lookup[d.key]).concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).on("filtered",function(chart,filters){if($scope.filters=chart.filters(),"row"==$scope.chart_show&&$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];chart.filters().length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}if("row"==$scope.chart_show&&!$scope.coming_from_map){var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}}).elasticX(!1).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])).xAxis().scale(rowChart.x()).tickValues([]),$scope.row_text=function(color_range){for(var color_level,i=0;i<$(".dc-chart g.row").length;i++){if(row=$(".dc-chart g.row")[i],fill=row.getElementsByTagName("rect")[0].getAttribute("fill"),selection=row.getElementsByTagName("rect")[0].getAttribute("class"),fill)for(j=0;j<color_range.length;j++)if(fill.toString().toLowerCase()==color_range[j].HEX.toLowerCase()){color_level=j;break}title=row.getElementsByTagName("title")[0].innerHTML,title||(string=(new XMLSerializer).serializeToString(row.getElementsByTagName("title")[0]),pos=string.indexOf(">"),title=string.substring(pos+1,pos+4)),text=row.getElementsByTagName("text")[0],"deselected"==selection&&"No Data"==title.substring(0,7)?text.style.fill="white":color_level<=2||"deselected"==selection||!fill||parseInt(title.substring(0,3))<3?text.style.fill="black":text.style.fill="white"}},$scope.sort=function(type){"value"===type?rowChart.ordering(function(d){return isNaN(d.value.sum)?0:-d.value.sum}):"name"==type&&rowChart.ordering(function(d){return 0==d.value?"zzz":lookup[d.key]}),rowChart.redraw()},$scope.scrollRowChart=function(){$("#tabular-wrapper").scrollTop(0)},$scope.map_coloring=function(id){var section_id=document.getElementById("section-"+$scope.metric);section_id&&section_id.classList.remove("section-active"),$scope.metric=id,$scope.metric_label=meta_label[id];var mapchartColors=$scope.mapchartColors(),cf_scores_metric=$scope.metric;whereGroupSum_scores.dispose(),whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),whereGroupSum_scores_tab.dispose(),whereGroupSum_scores_tab=whereDimension_tab.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),mapChart.group(whereGroupSum_scores).colors(mapchartColors).colorCalculator(function(d){if($scope.metric.indexOf("damage_class")>-1){var colors=$scope.quantileColorDomain_PI_std;if(1==d.sum)return colors[0];if(2==d.sum)return colors[1];if(3==d.sum)return colors[2];if(4==d.sum)return colors[3];if(5==d.sum)return colors[4]}else{if("pred_error_damage"!=$scope.metric)return d.count?mapChart.colors()(d.sum):"#cccccc";var colors=$scope.quantileColorDomain_PI_error;if(!d.count)return"#cccccc";if(d.sum<=-3)return colors[0];if(d.sum==-2)return colors[1];if(Math.abs(d.sum)<=1)return colors[2];if(2==d.sum)return colors[3];if(d.sum>=3)return colors[4]}}).popup(function(d){return lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",$scope.replace_null(meta_unit[$scope.metric]))});var xAxis=meta_scorevar[$scope.metric]?11:1.1*$scope.quantile_max;rowChart.group(whereGroupSum_scores_tab).ordering(function(d){return isNaN(d.value.sum)?0:-d.value.sum}).valueAccessor(function(d){return isNaN(d.value.sum)?0:d.value.sum}).colors(mapchartColors).colorCalculator(function(d){if($scope.metric.indexOf("damage_class")>-1){var colors=$scope.quantileColorDomain_PI_std;if(1==d.value.sum)return colors[0];if(2==d.value.sum)return colors[1];if(3==d.value.sum)return colors[2];if(4==d.value.sum)return colors[3];if(5==d.value.sum)return colors[4]}else{if("pred_error_damage"!=$scope.metric)return d.value.count?mapChart.colors()(d.value.sum):"#cccccc";var colors=$scope.quantileColorDomain_PI_error;if(!d.value.count)return"#cccccc";if(d.value.sum<=-3)return colors[0];if(d.value.sum==-2)return colors[1];if(Math.abs(d.value.sum)<=1)return colors[2];if(2==d.value.sum)return colors[3];if(d.value.sum>=3)return colors[4]}}).label(function(d){return meta_scorevar[$scope.metric]?dec2Format(d.value.sum).concat(" / 10 - ",lookup[d.key]):currentFormat(d.value.sum).concat(" ",meta_unit[$scope.metric]," - ",lookup[d.key])}).title(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).x(d3.scale.linear().range([0,rowChart.width()]).domain([0,xAxis])),dc.redrawAll(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("section-"+id).classList.add("section-active")},$scope.tutorial=function(){($scope.view_code="PI")?window.open("#!/#walkthrough_PI","_blank"):window.open("#!/#walkthrough","_blank")};for(var acc=document.getElementsByClassName("card-header level1"),active=(document.getElementsByClassName("collapse level1"),document.getElementsByClassName("collapse level1 in")[0]),i=0;i<acc.length;i++)acc[i].onclick=function(){var active_new=document.getElementById(this.id.replace("heading","collapse"));active.id!==active_new.id&&active.classList.remove("in"),active=active_new};$scope.info=function(id){"admin"!==id&&($scope.metric_label=meta_label[id]),$scope.metric_label_popup=meta_label[id],$scope.metric_year=meta_year[id],$scope.metric_source=meta_source[id],$scope.metric_desc=meta_desc[id],meta_icon[id]?$scope.metric_icon="modules/dashboards/img/"+meta_icon[id]:$scope.metric_icon="modules/dashboards/img/undefined.png",$("#infoModal").modal("show")},$scope.export_geojson=function(){var myWindow=window.open("","","_blank");myWindow.document.write(JSON.stringify(d.Districts)),myWindow.focus()},$scope.export_csv=function(){for(var content=d.Rapportage,finalVal="",i=0;i<content.length;i++){var key,innerValue,result,value=content[i];if(0===i){for(key in value)value.hasOwnProperty(key)&&(innerValue=meta_label[key]?meta_label[key]:meta_label[key.replace("_score","")]?meta_label[key.replace("_score","")]+" (0-10)":key,result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}for(key in value)value.hasOwnProperty(key)&&(innerValue=JSON.stringify(value[key]),result=innerValue.replace(/"/g,""),result.search(/("|,|\n)/g)>=0&&(result=""+result),"name"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}var download=document.getElementById("download");download.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(finalVal)),download.setAttribute("download","export.csv")},$scope.share_URL=function(){$scope.shareable_URL=addParameterToURL($scope.view_code,$scope.country_code,$scope.admlevel,$scope.metric,$scope.parent_codes,$scope.disaster_type,$scope.disaster_name,$scope.chart_show),$("#URLModal").modal("show")},$scope.share_country_URL=function(){$scope.shareable_URL=location.href+"?country="+$scope.country_code,$("#URLModal").modal("show")},$scope.copyToClipboard=function(element){var $temp=$("<input>");$("body").append($temp),$temp.val($(element).text()).select(),document.execCommand("copy"),$temp.remove()},$scope.mapShow=function(){if(0==$scope.filters.length)zoomToGeom($scope.geom);else{$scope.districts_temp=JSON.parse(JSON.stringify($scope.geom)),$scope.districts_temp.features=[];for(var i=0;i<$scope.geom.features.length;i++)$scope.filters.indexOf($scope.geom.features[i].properties.pcode)>-1&&$scope.districts_temp.features.push($scope.geom.features[i]);zoomToGeom($scope.districts_temp)}"row"==$scope.chart_show&&($scope.chart_show="map",$("#row-chart-container").hide(),$("#map-chart").show(),$scope.click_filter=!1,$scope.coming_from_tab=!0,$scope.click_filter=!0,$scope.coming_from_tab=!1),$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$scope.tabularShow=function(){$scope.chart_show="row",$("#map-chart").hide(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementById("row-chart-container").style.visibility="visible",$("#row-chart-container").show(),$scope.click_filter=!1,$scope.coming_from_map=!0,$scope.click_filter=!0,$scope.coming_from_map=!1,$(window).width()<768&&$("#demo.in").removeClass("in"),$(document).ready(function(){$(window).width()<768&&$(".collapse-button").addClass("collapsed")})},$(".view-buttons button").click(function(e){$(".view-buttons button.active").removeClass("active");var $this=$(this);$this.hasClass("active")||$this.addClass("active"),e.preventDefault()}),$scope.reset_function=function(){dc.filterAll(),dc.redrawAll();var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue),"map"==$scope.chart_show&&zoomToGeom($scope.geom)},dc.renderAll(),$scope.reload=1,map=mapChart.map(),zoomToGeom($scope.geom),"map"==$scope.chart_show?$("#row-chart-container").hide():"row"==$scope.chart_show&&$scope.tabularShow();var zoom_child=$(".leaflet-control-zoom")[0],zoom_parent=$(".leaflet-bottom.leaflet-right")[0];zoom_parent.insertBefore(zoom_child,zoom_parent.childNodes[0]);var sort_by;!function(){var default_cmp=function(a,b){return a==b?0:a<b?-1:1},getCmpFunc=function(primer,reverse){var dfc=default_cmp,cmp=default_cmp;return primer&&(cmp=function(a,b){return dfc(primer(a),primer(b))}),reverse?function(a,b){return-1*cmp(a,b)}:cmp};sort_by=function(){for(var field,name,cmp,fields=[],n_fields=arguments.length,i=0;i<n_fields;i++)field=arguments[i],"string"==typeof field?(name=field,cmp=default_cmp):(name=field.name,cmp=getCmpFunc(field.primer,field.reverse)),fields.push({name:name,cmp:cmp});return function(A,B){for(var name,result,i=0;i<n_fields&&(result=0,field=fields[i],name=field.name,result=field.cmp(A[name],B[name]),0===result);i++);return result}}}(),d.Country_meta_full.sort(sort_by("format",{name:"country_code",reverse:!1}));for(var ul=document.getElementById("country-items");ul.childElementCount>0;)ul.removeChild(ul.lastChild);for(var formats=[],countries=[],i=0;i<d.Disaster_meta_full.length;i++)if(null!==d.Disaster_meta_full[i].country_code&&countries.indexOf(d.Disaster_meta_full[i].country_code)<=-1&&("DDB"==$scope.view_code_PI&&"yes"==d.Disaster_meta_full[i].actuals||"PI"==$scope.view_code_PI&&"yes"==d.Disaster_meta_full[i].predictions)){countries.push(d.Disaster_meta_full[i].country_code);var record=d.Disaster_meta_full[i];if(formats.indexOf(record.format)<=-1&&formats.length>0){var li2=document.createElement("li");li2.setAttribute("class","divider"),ul.appendChild(li2)}var li=document.createElement("li");ul.appendChild(li);var a=document.createElement("a");a.setAttribute("class","submenu-item"),a.setAttribute("ng-click","change_country('"+record.country_code+"')"),a.setAttribute("role","button"),a.innerHTML=$scope.genLookup_country_meta(d,"country_name")[record.country_code],$compile(a)($scope),li.appendChild(a),formats.push(record.format)}for(var ul=document.getElementById("disaster-type-items");ul.childElementCount>0;)ul.removeChild(ul.lastChild);for(var formats=[],disaster_types=[],i=0;i<d.Disaster_meta_full.length;i++)if(d.Disaster_meta_full[i].country_code==$scope.country_code&&disaster_types.indexOf(d.Disaster_meta_full[i].disaster_type)<=-1){disaster_types.push(d.Disaster_meta_full[i].disaster_type);var record=d.Disaster_meta_full[i];if(formats.indexOf(record.format)<=-1&&formats.length>0){var li2=document.createElement("li");li2.setAttribute("class","divider"),ul.appendChild(li2)}var li=document.createElement("li");ul.appendChild(li);var a=document.createElement("a");a.setAttribute("class","submenu-item"),a.setAttribute("ng-click","change_disaster_type('"+record.disaster_type+"')"),a.setAttribute("role","button"),a.innerHTML=record.disaster_type,$compile(a)($scope),li.appendChild(a),formats.push(record.format)}$scope.changeLanguage=function(langKey){$translate.use(langKey);for(var i=0;i<$("#menu-buttons.in").length;i++)$("#menu-buttons.in")[i].classList.remove("in")},"PER"==$scope.country_code||"ECU"==$scope.country_code?(document.getElementById("language-selector").style.display="block",$scope.changeLanguage("es")):(document.getElementById("language-selector").style.display="none",$scope.changeLanguage("en")),$scope.translateData=function(){return{metric_label:$scope.metric,metric_label_popup:$scope.metric_info,metric_desc:"desc_"+$scope.metric_info,subtype_selection:$scope.subtype_selection}}},$(".sidebar-wrapper").addClass("in"),$(document).ready(function(){$(window).width()<768&&$(".sidebar-wrapper").removeClass("in")})}]),angular.module("dashboards").factory("Data",["$resource",function($resource){return $resource("data/:adminLevel",{adminLevel:"@_id"})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/signin.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication","$window",function($scope,$http,$location,Users,Authentication,$window){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,
Authentication.user=response,$window.location.reload()},function(response){$scope.error=response.data.message})},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})},$scope.languages=[{id:"nl_NL",name:"Nederlands"},{id:"en_EN",name:"English"}]}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);