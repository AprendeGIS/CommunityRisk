"use strict";var ApplicationConfiguration=function(){var applicationModuleName="Nederlandse Rode Kruis Dashboards",applicationModuleVendorDependencies=["ngResource","ngRoute","angularCSS","ngCookies","ngTouch","ngSanitize","ui.router","ui.bootstrap","leaflet-directive","angular-lodash","gettext","AngularDc","formsAngular","angular-loading-bar"],registerModule=function(moduleName){angular.module(moduleName,[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("dashboards"),ApplicationConfiguration.registerModule("forms"),ApplicationConfiguration.registerModule("maps"),ApplicationConfiguration.registerModule("users"),angular.module("core").run(["gettextCatalog","Authentication",function(gettextCatalog,Authentication){var language="nl_NL",user=Authentication.user;user&&user.language&&""!==user.language&&(language=user.language.id),gettextCatalog.currentLanguage=language,gettextCatalog.debug=!0}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("otherwise",{url:"/",templateUrl:"modules/core/views/home.client.view.html"}).state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function($scope,Authentication,Menus){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},angular.element(document).on("click.nav",function(e){$(e.target).is("a")&&$(this).removeClass("in").addClass("collapse")})}]),angular.module("core").controller("HomeController",["$scope","$css","$rootScope","Authentication","leafletData",function($scope,$css,$rootScope,Authentication,leafletData){$css.remove("modules/dashboards/css/storyboard.css"),$css.add("modules/dashboards/css/header.css"),$scope.authentication=Authentication,$rootScope.country_code="",$rootScope.disaster_type="",$rootScope.view_code="",$scope.choose_country=function(country){$rootScope.country_code=country},$scope.setup_PI=function(country,disaster_type){$rootScope.country_code=country,$rootScope.disaster_type=disaster_type},$scope.choose_view=function(view){$rootScope.view_code=view},angular.extend($scope,{defaults:{tileLayer:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:14,zoomControl:!1,path:{weight:10,color:"#800000",opacity:1}}}),angular.extend($scope,{layers:{baselayers:{osm:{name:"OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{showOnSelector:!1}}}}}),angular.extend($scope,{center:{lat:52.1185523,lng:5.2097174,zoom:10}}),leafletData.getMap().then(function(cartomap){cartomap.invalidateSize()}),$(document).ready(function(){$(".timer").countTo(),0!==$("#slider").length&&$("#slider").slick({dots:!0,infinite:!1,speed:300,slidesToShow:1,adaptiveHeight:!0,fade:!0,centerMode:!0}),0!==$("#slider_PI").length&&$("#slider_PI").slick({dots:!0,infinite:!1,speed:300,slidesToShow:1,adaptiveHeight:!0,fade:!0,centerMode:!0})})}]),angular.module("core").directive("heightresize",["$window",function($window){return{restrict:"A",link:function(scope,elem,attrs){var window=angular.element($window);scope.onResize=function(){$(elem).height($window.innerHeight-$(".navbar").height()-$(".mapHeader").height())},scope.onResize(),window.bind("resize",function(){scope.onResize(),scope.$apply()})}}}]).directive("logoresize",["$window",function($window){return{restrict:"A",link:function(scope,elem,attrs){var window=angular.element($window);scope.onResize=function(){$(elem).height(.75*(window.height()-$(".navbar").height()-$(".mapHeader").height()))},scope.onResize(),window.bind("resize",function(){scope.onResize(),scope.$apply()})}}}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["user"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:isPublic,roles:roles||this.defaultRoles,shouldRender:shouldRender}),this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].menuItemURL===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.addMenu("topbar",!0)}]),angular.module("dashboards").run(["Menus","gettextCatalog",function(Menus,gettextCatalog){var title=gettextCatalog.getString("Dashboards");Menus.addMenuItem("topbar",title,"dashboards","/dashboards",!0)}]),angular.module("dashboards").config(["$stateProvider",function($stateProvider){$stateProvider.state("listDashboards",{url:"/dashboards",templateUrl:"modules/dashboards/views/list-dashboards.client.view.html"}).state("createDashboard",{url:"/dashboards/create",templateUrl:"modules/dashboards/views/create-dashboards.client.view.html"}).state("viewDashboard",{url:"/dashboards/:dashboardId/:templateUrl",templateUrl:function($stateParams){return"modules/dashboards/views/"+$stateParams.templateUrl+".client.view.html"}}).state("editDashboard",{url:"/dashboards/:dashboardId/edit",templateUrl:"modules/dashboards/views/edit-dashboards.client.view.html"})}]),angular.module("dashboards").controller("DashboardsController",["$scope","$stateParams","$location","Authentication","Dashboards","CartoDB","$sce","$interval","$window",function($scope,$stateParams,$location,Authentication,Dashboards,CartoDB,$sce,$interval,$window){$scope.authentication=Authentication;var window=angular.element($window);$scope.create=function(){var dashboard=new Dashboards({name:this.name,description:this.description,url:this.url});dashboard.$save(function(response){$location.path("dashboards/"+response._id)},function(errorResponse){$scope.error=errorResponse.data.message}),this.name="",this.description="",this.url=""},$scope.remove=function(dashboard){if(dashboard){dashboard.$remove();for(var i in $scope.dashboards)$scope.dashboards[i]===dashboard&&$scope.dashboards.splice(i,1)}else $scope.dashboard.$remove(function(){$location.path("dashboards")})},$scope.update=function(){var dashboard=$scope.dashboard;dashboard.$update(function(){$location.path("dashboards/"+dashboard._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.dashboards=Dashboards.query()},$scope.findOne=function(){$scope.dashboard=Dashboards.get({dashboardId:$stateParams.dashboardId})},$scope.onResize=function(){var newHeight=$("window").innerHeight-$(".navbar").height()-$(".dashboardHeader").height();$(".dashboardVerticalStretch").css("height",newHeight),$(".dashboardVerticalStretch").css("minHeight",newHeight)},$scope.onResize(),window.bind("resize",function(){$scope.onResize()})}]),angular.module("dashboards").controller("DistrictDashboardsController",["$scope","$css","$rootScope","$compile","$q","Authentication","Dashboards","Data","Sources","$window","$stateParams","cfpLoadingBar","_",function($scope,$css,$rootScope,$compile,$q,Authentication,Dashboards,Data,Sources,$window,$stateParams,cfpLoadingBar,_){$css.add(["modules/dashboards/css/header.css","modules/dashboards/css/dashboards.css"]),$scope.change_view=function(view){$rootScope.view_code=view},$scope.change_disaster_type=function(disaster_type){$scope.disaster_type=disaster_type,$scope.disaster_name="Typhoon"==$scope.disaster_type?"Haima":"Leyte 2017",$scope.initiate("PI")},$scope.change_country=function(country){$scope.country_code=country,$scope.parent_codes=[],$scope.metric="",$scope.initiate("CRA")},$rootScope.loadCount=0,$scope.authentication=Authentication,$scope.geom=null,$scope.country_code="MW",$scope.view_code="CRA",$scope.disaster_type="Typhoon",$scope.metric="",$rootScope.country_code&&($scope.country_code=$rootScope.country_code),$rootScope.disaster_type&&($scope.disaster_type=$rootScope.disaster_type),$scope.disaster_name="Typhoon"==$scope.disaster_type?"Haima":"Leyte 2017",$rootScope.view_code&&($scope.view_code=$rootScope.view_code),"PI"==$scope.view_code&&($scope.country_code="PH"),"CRA"==$scope.view_code?$scope.admlevel=2:$scope.admlevel=3,$scope.metric_label="",$scope.metric_year="",$scope.metric_source="",$scope.metric_desc="",$scope.metric_icon="",$scope.admlevel_text="",$scope.name_selection="",$scope.name_selection_prev="",$scope.name_popup="",$scope.value_popup=0,$scope.country_selection="",$scope.parent_codes=[],$scope.data_input="",$scope.filters=[],$scope.tables=[],$scope.x=500,$scope.y=200,$scope.quantileColorDomain_PI_std=["#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"],$scope.quantileColorDomain_PI_error=["#d7191c","#fdae61","#ffffbf","#DA70D6","#8B008B"],$scope.quantileColorDomain_CRA_std=["#f1eef6","#bdc9e1","#74a9cf","#2b8cbe","#045a8d"],$scope.quantileColorDomain_CRA_scores=["#1a9641","#a6d96a","#f1d121","#fd6161","#d7191c"];var map,mapfilters_length=0,d_prev="";$scope.config={whereFieldName:"pcode",joinAttribute:"pcode",nameAttribute:"name",color:"#0080ff"},$scope.start=function(){cfpLoadingBar.start()},$scope.complete=function(){cfpLoadingBar.complete()},$scope.initiate=function(view_code){$scope.start(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("level2")&&document.getElementById("level2").setAttribute("class","btn btn-secondary"),document.getElementById("level3")&&document.getElementById("level3").setAttribute("class","btn btn-secondary"),$scope.view_code=view_code,$rootScope.view_code=view_code,"PI"==$scope.view_code&&($scope.country_code="PH"),$scope.admlevel="CRA"==$scope.view_code?2:3,["MLI","ZMB"].indexOf($scope.country_code)>-1&&($scope.admlevel=1),$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Dashboards.get({dashboardId:$stateParams.dashboardId},function(dashboard){Data.get({adminLevel:$scope.data_input},function(pgData){$scope.prepare(dashboard,pgData)})},function(error){console.log(error)})},$scope.reload=function(d){$scope.start(),$scope.parent_codes_input="{"+$scope.parent_codes.join(",")+"}",$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_codes_input+"','"+$scope.view_code+"','"+$scope.disaster_type+"','"+$scope.disaster_name+"'",Data.get({adminLevel:$scope.data_input},function(pgData){$scope.prepare_reload(d,pgData)})},$scope.prepare=function(dashboard,pgData){var d={};d.Rapportage=pgData.usp_data.ind;for(var pcode_list=[],i=0;i<d.Rapportage.length;i++)pcode_list[i]=d.Rapportage[i].pcode;if(d.Districts=pgData.usp_data.geo,d.Districts.features=$.grep(d.Districts.features,function(e){return pcode_list.indexOf(e.properties.pcode)>-1}),$scope.geom=d.Districts,d.dpi_temp=pgData.usp_data.dpi,d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata_full=dashboard.sources.Metadata.data,d.Metadata="CRA"===$scope.view_code?$.grep(d.Metadata_full,function(e){return"CRA"==e.view_code&&e.country_code.indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}):$.grep(d.Metadata_full,function(e){return"PI"==e.view_code&&e.disaster_type.indexOf($scope.disaster_type)>-1&&e.country_code.indexOf($scope.country_code)>-1}),d.Country_meta=dashboard.sources.Country_meta.data,d.Country_meta=$.grep(d.Country_meta,function(e){return e.country_code==$scope.country_code}),"PI"==$scope.view_code&&(d.Disaster_meta=$.grep(dashboard.sources.Metadata_disaster_events.data,function(e){return e.disaster_type==$scope.disaster_type})),console.log(d),$scope.generateCharts(d),$scope.complete(),"undefined"!=typeof L_PREFER_CANVAS&&$("#IEmodal").modal("show")},$scope.prepare_reload=function(d,pgData){if($scope.title=$scope.config.title,$scope.mapChartType="leafletChoroplethChart",d.Districts=pgData.usp_data.geo,$scope.geom=pgData.usp_data.geo,d.Rapportage=pgData.usp_data.ind,d.dpi=[],d.dpi_temp)for(var i=0;i<d.dpi_temp.length;i++)d.dpi_temp[i].admin_level==$scope.admlevel&&(d.dpi[0]=d.dpi_temp[i]);d.Metadata="CRA"===$scope.view_code?$.grep(d.Metadata_full,function(e){return"CRA"==e.view_code&&e.country_code.indexOf($scope.country_code)>-1&&e.admin_level>=$scope.admlevel&&e.admin_level_min<=$scope.admlevel}):$.grep(d.Metadata_full,function(e){return"PI"==e.view_code&&e.disaster_type.indexOf($scope.disaster_type)>-1&&e.country_code.indexOf($scope.country_code)>-1}),$scope.generateCharts(d),$scope.complete()},$scope.genLookup=function(field){var lookup={};return $scope.geom.features.forEach(function(e){lookup[e.properties[$scope.config.joinAttribute]]=String(e.properties[field])}),lookup},$scope.genLookup_meta=function(d,field){var lookup_meta={};return d.Metadata.forEach(function(e){lookup_meta[e.variable]=String(e[field])}),lookup_meta},$scope.genLookup_country_meta=function(d,field){var lookup_country_meta={};return d.Country_meta.forEach(function(e){lookup_country_meta[e.country_code]=String(e[field])}),lookup_country_meta},$scope.genLookup_disaster_meta=function(d,field){var lookup_disaster_meta={};return d.Disaster_meta.forEach(function(e){lookup_disaster_meta[e.name]=String(e[field])}),lookup_disaster_meta},$scope.deepFind=function(obj,path){var i,paths=path.split("."),current=obj;for(i=0;i<paths.length;++i){if(void 0===current[paths[i]])return;current=current[paths[i]]}return current},$scope.generateCharts=function(d){function zoomToGeom(geom){var bounds=d3.geo.bounds(geom);map.fitBounds([[bounds[0][1],bounds[0][0]],[bounds[1][1],bounds[1][0]]])}dc.chartRegistry.clear(),void 0!==map&&map.remove();var mapChart=dc.leafletChoroplethChart("#map-chart"),country_name=$scope.genLookup_country_meta(d,"country_name"),country_zoom_min=($scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name"),$scope.genLookup_country_meta(d,"zoomlevel_min")),country_zoom_max=$scope.genLookup_country_meta(d,"zoomlevel_max"),country_default_metric=$scope.genLookup_country_meta(d,"default_metric");$scope.country_selection=country_name[$scope.country_code];var zoom_min=Number(country_zoom_min[$scope.country_code]),zoom_max=Number(country_zoom_max[$scope.country_code]);"PI"===$scope.view_code?$scope.metric=$scope.genLookup_disaster_meta(d,"default_metric")[$scope.disaster_name]:""===$scope.metric?$scope.metric=country_default_metric[$scope.country_code]:"undefined"==typeof d.Rapportage[0][$scope.metric]&&($scope.metric="population"),$scope.admlevel===zoom_min&&($scope.name_selection=country_name[$scope.country_code]),2>zoom_max-zoom_min?document.getElementById("level3").style.visibility="hidden":document.getElementById("level3")&&(document.getElementById("level3").style.visibility="visible");var lookup=$scope.genLookup($scope.config.nameAttribute),meta_label=$scope.genLookup_meta(d,"label"),meta_format=$scope.genLookup_meta(d,"format"),meta_unit=$scope.genLookup_meta(d,"unit"),meta_icon=$scope.genLookup_meta(d,"icon_src"),meta_year=$scope.genLookup_meta(d,"year"),meta_source=$scope.genLookup_meta(d,"source_link"),meta_desc=$scope.genLookup_meta(d,"description"),meta_scorevar=$scope.genLookup_meta(d,"scorevar_name");$scope.metric_label=meta_label[$scope.metric],$scope.type_selection=$scope.admlevel==zoom_min?"Country":$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code],$scope.subtype_selection=$scope.genLookup_country_meta(d,"level"+$scope.admlevel+"_name")[$scope.country_code],"MW"==$scope.country_code?($scope.admlevel==zoom_min?($scope.levelB_selection="All "+$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.levelB_code="",$scope.levelB_codes=[]):$scope.admlevel<zoom_max&&$scope.parent_codes.length>0&&($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes),$scope.admlevel<zoom_max?($scope.levelC_selection=0==$scope.parent_codes.length?"All "+$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code]:void 0,$scope.levelC_code=""):$scope.parent_codes.length>0&&($scope.levelC_selection=$scope.name_selection,$scope.levelC_code=$scope.parent_code)):($scope.admlevel==zoom_min?($scope.levelB_selection=void 0,$scope.levelB_codes=[]):$scope.admlevel<zoom_max&&void 0==$scope.levelB_selection&&($scope.levelB_selection=$scope.name_selection,$scope.levelB_codes=$scope.parent_codes),$scope.levelC_selection=$scope.admlevel<zoom_max?void 0:$scope.name_selection,$scope.levelC_code=$scope.admlevel<zoom_max?"":$scope.parent_code),$scope.tables=[];for(var i=0;i<d.Metadata.length;i++){var record={},record_temp=d.Metadata[i];record.id="data-table"+[i+1],record.name=record_temp.variable,record.group=record_temp.group,record.propertyPath="sum"===record_temp.agg_method?"value":"value.finalVal",record.dimension=void 0,record.weight_var=record_temp.weight_var,record.scorevar_name=record_temp.scorevar_name,record.view=record_temp.view_code,$scope.tables[i]=record}var dec0Format=(d3.format(","),d3.format(",.0f")),dec2Format=(d3.format(",.1f"),d3.format(".2f")),percFormat=d3.format(",.2%"),currentFormat=function(value){return"decimal0"===meta_format[$scope.metric]?dec0Format(value):"decimal2"===meta_format[$scope.metric]?dec2Format(value):"percentage"===meta_format[$scope.metric]?percFormat(value):void 0},cf=crossfilter(d.Rapportage),whereDimension=cf.dimension(function(d){return d.pcode}),cf_scores_metric=(whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric),whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var reduceAddAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub+=v[metricA]*v[metricB],p.sumOfTotal+=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceRemoveAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub-=v[metricA]*v[metricB],p.sumOfTotal-=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceInitialAvg=function(){return{sumOfSub:0,sumOfTotal:0,finalVal:0}},totaalDim=cf.dimension(function(i){return"Total"}),dimensions=[];$scope.tables.forEach(function(t){var name=t.name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions[name]=totaalDim.group().reduce(reduceAddAvg([name],[weight_var]),reduceRemoveAvg([name],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions[name]=totaalDim.group().reduceSum(function(d){return d[name]}))});var dimensions_scores=[];$scope.tables.forEach(function(t){var name=t.name;if(t.scorevar_name){var name_score=t.scorevar_name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions_scores[name]=totaalDim.group().reduce(reduceAddAvg([name_score],[weight_var]),reduceRemoveAvg([name_score],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions_scores[name]=totaalDim.group().reduceSum(function(d){return d[name_score]}))}});var i;for(i=0;i<d.Metadata.length;i++){var name=$scope.tables[i].name;$scope.tables[i].dimension=dimensions[name]}if("PI"===$scope.view_code){$scope.actuals=$scope.genLookup_disaster_meta(d,"actuals")[$scope.disaster_name],$scope.predictions=$scope.genLookup_disaster_meta(d,"predictions")[$scope.disaster_name],$scope.metric_label=meta_label[$scope.metric],"yes"==$scope.actuals&&"no"==$scope.predictions?$scope.type_text="This historical "+$scope.disaster_type.toLowerCase()+" was used to develop this model, but was never used to make predictions at the time.":"yes"==$scope.actuals&&"yes"==$scope.predictions?$scope.type_text="For this "+$scope.disaster_type.toLowerCase()+" priority areas were predicted using the model, and actual damage was collected later, so prediction errors can be measured.":"no"==$scope.actuals&&"yes"==$scope.predictions&&($scope.type_text="For this "+$scope.disaster_type.toLowerCase()+" priority areas were predicted using the model, but actual damage is not yet collected, so prediction errors cannot be measured yet."),$scope.start_date=$scope.genLookup_disaster_meta(d,"startdate")[$scope.disaster_name],$scope.end_date="Typhoon"==$scope.disaster_type?"to "+$scope.genLookup_disaster_meta(d,"enddate")[$scope.disaster_name]:"";var total_damage_temp=dimensions.total_damage_houses.top(1)[0].value>0?dimensions.total_damage_houses.top(1)[0].value:dimensions.total_damage_houses_pred?dimensions.total_damage_houses_pred.top(1)[0].value:0;$scope.total_damage=dec0Format(total_damage_temp),$scope.total_potential=dec0Format(dimensions.total_houses.top(1)[0].value);var total_intensity=total_damage_temp/dimensions.total_houses.top(1)[0].value;isNaN(total_intensity)?$scope.total_intensity=percFormat(0):$scope.total_intensity=percFormat(total_intensity);for(var events=document.getElementById("events"),drop_events=document.getElementsByClassName("event-drop");drop_events[0];)drop_events[0].parentNode.removeChild(drop_events[0]);for(i=0;i<d.Disaster_meta.length;i++)if(record=d.Disaster_meta[i],record.disaster_type==$scope.disaster_type){if("yes"==record.actuals&&"no"==record.predictions)var act_pred="act";else if("yes"==record.actuals&&"yes"==record.predictions)var act_pred="act_pred";else if("no"==record.actuals&&"yes"==record.predictions)var act_pred="pred";var li=document.createElement("li");events.insertBefore(li,document.getElementById(act_pred).nextSibling);var a=document.createElement("a");a.setAttribute("ng-click","change_disaster('"+record.name+"')"),a.setAttribute("class","event-drop"),a.innerHTML=record.name,li.appendChild(a),$compile(a)($scope)}}var fill_keyvalues=function(){var keyvalue=[];return $scope.tables.forEach(function(t){var key=t.name;"dpi"==t.group?keyvalue[key]=dec2Format(d.dpi[0][t.name]):$scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[t.name])?"value.finalVal"===t.propertyPath?isNaN(dimensions[t.name].top(1)[0].value.finalVal)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value.finalVal):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value.finalVal):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value.finalVal)):"value"===t.propertyPath&&(isNaN(dimensions[t.name].top(1)[0].value)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value))):"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(d_prev[t.name]):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(d_prev[t.name]):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(d_prev[t.name]))}),keyvalue},keyvalue=fill_keyvalues();if($scope.admlevel==zoom_min){var quantile_range_scores=[],j=0;for(i=0;i<d.Rapportage.length;i++)Object.keys(d.Rapportage[i]).forEach(function(key,index){meta_scorevar[key]&&(d.Rapportage[i][meta_scorevar[key]]||0==d.Rapportage[i][meta_scorevar[key]])&&(quantile_range_scores[j]=d.Rapportage[i][meta_scorevar[key]],j+=1)});quantile_range_scores.sort(function(a,b){return a-b}),d.quantile_range_scores=quantile_range_scores;for(var quantile=function(values,p){var H=(values.length-1)*p+1,h=Math.floor(H),v=+values[h-1],e=H-h;return e?v+e*(values[h]-v):v},k=0,q=5,thresholds=[];++k<q;)thresholds[k-1]=Math.round(100*quantile(quantile_range_scores,k/q))/100;d.thresholds=thresholds}var high_med_low=function(ind,ind_score,group){if(dimensions_scores[ind]){if("dpi"==group)var width=10*(1-d.dpi[0][ind]);else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[ind_score]))var width=dimensions_scores[ind].top(1)[0].value.finalVal;else var width=d_prev[ind_score];if("dpi_score"==ind)return.1>1-width/10?"bad":"good";if(isNaN(width))return"notavailable";if(width<d.thresholds[0])return"good";if(width<=d.thresholds[1])return"medium-good";if(width<=d.thresholds[2])return"medium";if(width<=d.thresholds[3])return"medium-bad";if(width>d.thresholds[3])return"bad"}};$scope.createHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));var general=document.getElementById("general"),dpi=document.getElementById("dpi"),scores=document.getElementById("scores"),vulnerability=document.getElementById("vulnerability"),hazard=document.getElementById("hazard"),coping=document.getElementById("coping"),other=document.getElementById("other");if(general)for(;general.firstChild;)general.removeChild(general.firstChild);if(dpi)for(;dpi.firstChild;)dpi.removeChild(dpi.firstChild);if(scores)for(;scores.firstChild;)scores.removeChild(scores.firstChild);if(vulnerability)for(;vulnerability.firstChild;)vulnerability.removeChild(vulnerability.firstChild);if(hazard)for(;hazard.firstChild;)hazard.removeChild(hazard.firstChild);if(coping)for(;coping.firstChild;)coping.removeChild(coping.firstChild);if(other)for(;other.firstChild;)other.removeChild(other.firstChild);var predictions=document.getElementById("predictions"),damage=document.getElementById("damage"),pred_error=document.getElementById("pred_error"),disaster=document.getElementById("disaster"),geographic=document.getElementById("geographic");if(predictions)for(;predictions.firstChild;)predictions.removeChild(predictions.firstChild);if(damage)for(;damage.firstChild;)damage.removeChild(damage.firstChild);if(pred_error)for(;pred_error.firstChild;)pred_error.removeChild(pred_error.firstChild);if(disaster)for(;disaster.firstChild;)disaster.removeChild(disaster.firstChild);if(geographic)for(;geographic.firstChild;)geographic.removeChild(geographic.firstChild);for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if(meta_icon[record.name])var icon="modules/dashboards/img/"+meta_icon[record.name];else var icon="modules/dashboards/img/undefined.png";if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div=document.createElement("div");div.setAttribute("class","row profile-item");var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col col-md-1"),div.appendChild(div0);var img=document.createElement("img");img.setAttribute("class","community-icon"),img.setAttribute("src",icon),div0.appendChild(img);var div1=document.createElement("div");div1.setAttribute("class","col col-md-5 general-component-label"),div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],div.appendChild(div1),$compile(div1)($scope);var div2=document.createElement("div");div2.setAttribute("class","col col-md-4"),div2.setAttribute("id",record.name),div2.innerHTML=keyvalue[record.name]+" "+unit,div.appendChild(div2);var div3=document.createElement("div");div3.setAttribute("class","col col-md-2"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img=document.createElement("img");img.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img.setAttribute("style","height:17px"),button.appendChild(img)}else if("other"===record.group||"PI"===record.view){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div=document.createElement("div");div.setAttribute("class","component-section");var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-8 component-label"),div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div3=document.createElement("div");div3.setAttribute("class","col-sm-2 col-md-2 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),
button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}else if(record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div=document.createElement("div");div.setAttribute("class","component-section");var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-3 component-label"),"dpi"!==record.group&&div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name]+" "+unit,div1.appendChild(div1a);var div2=document.createElement("div");div2.setAttribute("class","col-md-5"),div.appendChild(div2);var div2a=document.createElement("div");div2a.setAttribute("class","component-scale"),div2.appendChild(div2a);var div2a1=document.createElement("div");div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("id","bar-"+record.name),div2a1.setAttribute("style","width:"+width+"%"),div2a.appendChild(div2a1);var div3=document.createElement("div");div3.setAttribute("class","col-sm-2 col-md-2 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}},$scope.createHTML(keyvalue),$scope.updateHTML=function(keyvalue){var dpi_score=document.getElementById("dpi_score_main");dpi_score&&(dpi_score.textContent=keyvalue.dpi_score,dpi_score.setAttribute("class","component-score "+high_med_low("dpi_score","dpi_score","dpi")));var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];if("general"===record.group){var div2=document.getElementById(record.name);div2.innerHTML=keyvalue[record.name]+" "+unit}else if("other"===record.group||"PI"===record.view){if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];if(!("no"==$scope.predictions&&"predictions"==record.group||"no"==$scope.actuals&&"damage"==record.group||("no"==$scope.predictions||"no"==$scope.actuals)&&"pred_error"==record.group)){var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.innerHTML=keyvalue[record.name]+" "+unit}}else if(record.group){if("dpi"==record.group)var width=100*d.dpi[0][record.name];else if($scope.admlevel!=zoom_max||0!=$scope.filters.length||isNaN(d_prev[record.scorevar_name]))var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;else var width=10*d_prev[record.scorevar_name];var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name,record.group)),div1a.innerHTML=keyvalue[record.name]+" "+unit;var div2a1=document.getElementById("bar-"+record.name);div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name,record.group)),div2a1.setAttribute("style","width:"+width+"%")}}},$scope.mapchartColors=function(){var quantile_range=[];if(meta_scorevar[$scope.metric])quantile_range=d.quantile_range_scores;else for(i=0;i<d.Rapportage.length;i++)quantile_range[i]=meta_scorevar[$scope.metric]?d.Rapportage[i][meta_scorevar[$scope.metric]]:d.Rapportage[i][$scope.metric],quantile_range.sort();var colorDomain;return colorDomain="CRA"==$scope.view_code?meta_scorevar[$scope.metric]?$scope.quantileColorDomain_CRA_scores:$scope.quantileColorDomain_CRA_std:Math.min.apply(null,quantile_range)<0&&Math.max.apply(null,quantile_range)>0?$scope.quantileColorDomain_PI_error:$scope.quantileColorDomain_PI_std,d3.scale.quantile().domain(quantile_range).range(colorDomain)};var mapchartColors=$scope.mapchartColors();mapChart.width($("#map-chart").width()).height(800).dimension(whereDimension).group(whereGroupSum_scores).center([0,0]).zoom(0).geojson(d.Districts).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).featureKeyAccessor(function(feature){return feature.properties.pcode}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}).renderPopup(!0).turnOnControls(!0).on("filtered",function(chart,filters){$scope.filters=chart.filters();var popup=document.getElementById("mapPopup");popup.style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.filters.length>mapfilters_length&&($scope.$apply(function(){$scope.name_popup=lookup[$scope.filters[$scope.filters.length-1]];for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[$scope.filters.length-1]){$scope.value_popup=currentFormat(record[$scope.metric]),$scope.value_popup_unit=meta_unit[$scope.metric];break}}$scope.metric_label=meta_label[$scope.metric]}),"undefined"!=typeof event?(popup.style.left=Math.min($(window).width()-210,event.pageX)+"px",popup.style.top=Math.min($(window).height()-210,event.pageY)+"px"):(popup.style.left="400px",popup.style.top="100px"),popup.style.visibility="visible",$scope.admlevel<zoom_max&&"PI"!==$scope.view_code&&(document.getElementById("zoomin_icon").style.visibility="visible")),mapfilters_length=$scope.filters.length;var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}),"PI"!=$scope.view_code&&"CRA"!=$scope.view_code||mapChart.legend(dc.leafletLegend().position("topright")),$scope.zoom_in=function(){if($scope.filters.length>0&&$scope.admlevel<zoom_max){if($scope.admlevel=$scope.admlevel+1,$scope.parent_code_prev=$scope.parent_code,$scope.name_selection_prev=$scope.name_selection,$scope.parent_codes=$scope.filters,$scope.name_selection=$scope.filters.length>1?"Multiple "+$scope.genLookup_country_meta(d,"level"+($scope.admlevel-1)+"_name")[$scope.country_code]:lookup[$scope.parent_codes[0]],$scope.admlevel==zoom_max)for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[0]){d_prev=record;break}}$scope.filters=[],$scope.reload(d),document.getElementById("level"+($scope.admlevel-zoom_min+1)).setAttribute("class","btn btn-secondary btn-active"),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",mapfilters_length=0}},$scope.zoom_out=function(dest_level){var admlevel_old=$scope.admlevel;for("MW"==$scope.country_code?1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.levelB_selection="All "+$scope.genLookup_country_meta(d,"level"+(zoom_min+1)+"_name")[$scope.country_code],$scope.reload(d)):2===dest_level&&$scope.admlevel>zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.levelC_selection="All "+$scope.genLookup_country_meta(d,"level"+(zoom_min+2)+"_name")[$scope.country_code],$scope.reload(d)):2===dest_level&&$scope.admlevel<zoom_min+1?($scope.admlevel=zoom_min+1,$scope.parent_codes=[],$scope.name_selection=$scope.levelB_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),$scope.reload(d)):3===dest_level&&$scope.admlevel<zoom_min+2&&0==$scope.parent_codes.length&&($scope.admlevel=zoom_min+2,$scope.parent_codes=[],$scope.name_selection=$scope.levelC_selection,document.getElementById("level2").setAttribute("class","btn btn-secondary btn-active"),document.getElementById("level3").setAttribute("class","btn btn-secondary btn-active"),$scope.reload(d)):1===dest_level&&$scope.admlevel>zoom_min?($scope.admlevel=zoom_min,$scope.parent_codes=[],$scope.reload(d)):2===dest_level&&$scope.admlevel>zoom_min+1&&($scope.admlevel=zoom_min+1,$scope.parent_codes=$scope.levelB_codes,$scope.name_selection=$scope.name_selection_prev,$scope.reload(d));admlevel_old-zoom_min>dest_level-1;)document.getElementById("level"+(admlevel_old-zoom_min+1)).setAttribute("class","btn btn-secondary"),admlevel_old-=1;document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden"},$scope.map_coloring=function(id){$scope.metric=id,$scope.metric_label=meta_label[id];var mapchartColors=$scope.mapchartColors();whereGroupSum_scores.dispose(),cf_scores_metric=meta_scorevar[$scope.metric]?meta_scorevar[$scope.metric]:$scope.metric,whereGroupSum_scores=whereDimension.group().reduce(function(p,v){return p.count=null!==v[cf_scores_metric]?p.count+1:p.count,p.sum=p.sum+v[cf_scores_metric],p},function(p,v){return p.count=null!==v[cf_scores_metric]?p.count-1:p.count,p.sum=p.sum-v[cf_scores_metric],p},function(){return{count:0,sum:0}}),mapChart.group(whereGroupSum_scores).colors(mapchartColors).colorCalculator(function(d){return d.count?mapChart.colors()(d.sum):"#cccccc"}).popup(function(d){return meta_scorevar[$scope.metric]?lookup[d.key].concat(" - ",meta_label[$scope.metric]," (0-10): ",dec2Format(d.value.sum)):lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value.sum)," ",meta_unit[$scope.metric])}),dc.filterAll(),dc.redrawAll(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden"},$scope.change_disaster=function(disaster_name){$scope.disaster_name=disaster_name,$scope.initiate("PI")},$scope.tutorial=function(){($scope.view_code="PI")?window.open("#!/#walkthrough_PI","_blank"):window.open("#!/#walkthrough","_blank")};for(var acc=document.getElementsByClassName("card-header"),active=(document.getElementsByClassName("collapse"),document.getElementsByClassName("collapse in")[0]),i=0;i<acc.length;i++)acc[i].onclick=function(){var active_new=document.getElementById(this.id.replace("heading","collapse"));active.id!==active_new.id&&active.classList.remove("in"),active=active_new};$scope.info=function(id){$scope.metric=id,$scope.metric_label=meta_label[$scope.metric],$scope.metric_year=meta_year[$scope.metric],$scope.metric_source=meta_source[$scope.metric],$scope.metric_desc=meta_desc[$scope.metric],meta_icon[$scope.metric]?$scope.metric_icon="modules/dashboards/img/"+meta_icon[$scope.metric]:$scope.metric_icon="modules/dashboards/img/undefined.png",$("#infoModal").modal("show")},$scope.export_csv=function(){for(var content=d.Rapportage,i=0;i<content.length;i++)content[i].name=lookup[content[i].pcode];for(var finalVal="",i=0;i<content.length;i++){var key,innerValue,result,value=content[i];if(0===i){for(key in value)value.hasOwnProperty(key)&&(innerValue=key,result=innerValue.replace(/"/g,'""'),result.search(/("|,|\n)/g)>=0&&(result='"'+result+'"'),"pcode"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}for(key in value)value.hasOwnProperty(key)&&(innerValue=JSON.stringify(value[key]),result=innerValue.replace(/"/g,'""'),result.search(/("|,|\n)/g)>=0&&(result='"'+result+'"'),"pcode"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}var download=document.getElementById("download");download.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(finalVal)),download.setAttribute("download","export.csv")},dc.renderAll(),map=mapChart.map(),zoomToGeom($scope.geom)},$(document).ready(function(){$(".dropdown-submenu a.menu-item").on("click",function(e){$(".submenu-items.open").toggle().removeClass("open"),$(this).next("ul").toggle().addClass("open"),e.stopPropagation(),e.preventDefault()})})}]),angular.module("dashboards").controller("InformGlobalController",["$scope","$css","$rootScope","$compile","$q","Authentication","Dashboards","Data","Sources","$window","$stateParams","cfpLoadingBar","_",function($scope,$css,$rootScope,$compile,$q,Authentication,Dashboards,Data,Sources,$window,$stateParams,cfpLoadingBar,_){$css.add(["modules/dashboards/css/header.css","modules/dashboards/css/dashboards.css"]),$scope.authentication=Authentication,$scope.geom=null,$scope.country_code="INFORM",$rootScope.country_code&&($scope.country_code=$rootScope.country_code),$scope.admlevel=2,$scope.metric="",$scope.metric_label="",$scope.metric_year="",$scope.metric_source="",$scope.metric_desc="",$scope.metric_icon="",$scope.admlevel_text="",$scope.name_selection="",$scope.name_selection_prev="",$scope.name_popup="",$scope.value_popup=0,$scope.country_selection="",$scope.level2_selection=void 0,$scope.level3_selection=void 0,$scope.level2_code="",$scope.level3_code="",$scope.type_selection="",$scope.subtype_selection="",$scope.parent_code="",$scope.data_input="",$scope.filters=[],$scope.tables=[],$scope.x=500,$scope.y=200;var map,mapfilters_length=0,d_prev="";$scope.config={whereFieldName:"pcode",joinAttribute:"pcode",nameAttribute:"name",color:"#0080ff"},$scope.start=function(){cfpLoadingBar.start()},$scope.complete=function(){cfpLoadingBar.complete()},$scope.initiate=function(){$scope.start(),$scope.metric="",$scope.admlevel=2,$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_code+"','CRA','',''",Dashboards.get({dashboardId:$stateParams.dashboardId},function(dashboard){Data.get({adminLevel:$scope.data_input},function(pgData){$scope.prepare(dashboard,pgData)})},function(error){console.log(error)})},$scope.reload=function(d){$scope.start(),$scope.data_input=$scope.admlevel+",'"+$scope.country_code+"','"+$scope.parent_code,Data.get({adminLevel:$scope.data_input},function(pgData){$scope.prepare_reload(d,pgData)})},$scope.prepare=function(dashboard,pgData){$scope.title=$scope.config.title,$scope.mapChartType="leafletChoroplethChart";var d={};d.Districts=pgData.usp_data.geo,d.Rapportage=pgData.usp_data.ind;var meta=dashboard.sources.Metadata.data;d.Metadata=$.grep(meta,function(e){return e.country_code==$scope.country_code}),d.Country_meta=dashboard.sources.Country_meta.data,$scope.geom=d.Districts,console.log(d),$scope.generateCharts(d),$scope.complete(),"undefined"!=typeof L_PREFER_CANVAS&&$("#IEmodal").modal("show")},$scope.prepare_reload=function(d,pgData){$scope.title=$scope.config.title,$scope.mapChartType="leafletChoroplethChart",d.Districts=pgData.usp_data.geo,d.Rapportage=pgData.usp_data.ind,$scope.geom=pgData.usp_data.geo,$scope.generateCharts(d),$scope.complete()},$scope.genLookup=function(field){var lookup={};return $scope.geom.features.forEach(function(e){lookup[e.properties[$scope.config.joinAttribute]]=String(e.properties[field])}),lookup},$scope.genLookup_meta=function(d,field){var lookup_meta={};return d.Metadata.forEach(function(e){lookup_meta[e.variable]=String(e[field])}),lookup_meta},$scope.genLookup_country_meta=function(d,field){var lookup_country_meta={};return d.Country_meta.forEach(function(e){lookup_country_meta[e.country_code]=String(e[field])}),lookup_country_meta},$scope.deepFind=function(obj,path){var i,paths=path.split("."),current=obj;for(i=0;i<paths.length;++i){if(void 0===current[paths[i]])return;current=current[paths[i]]}return current},$scope.generateCharts=function(d){function zoomToGeom(geom){var bounds=d3.geo.bounds(geom);map.fitBounds([[bounds[0][1],bounds[0][0]],[bounds[1][1],bounds[1][0]]])}dc.chartRegistry.clear(),void 0!==map&&map.remove();var mapChart=dc.leafletChoroplethChart("#map-chart"),country_name=$scope.genLookup_country_meta(d,"country_name"),country_level2=$scope.genLookup_country_meta(d,"level2_name"),country_level3=$scope.genLookup_country_meta(d,"level3_name"),country_level4=$scope.genLookup_country_meta(d,"level4_name"),country_zoom_min=$scope.genLookup_country_meta(d,"zoomlevel_min"),country_zoom_max=$scope.genLookup_country_meta(d,"zoomlevel_max"),country_default_metric=$scope.genLookup_country_meta(d,"default_metric");$scope.country_selection=country_name[$scope.country_code];var zoom_min=country_zoom_min[$scope.country_code],zoom_max=country_zoom_max[$scope.country_code];""===$scope.metric&&($scope.metric=country_default_metric[$scope.country_code]),2===$scope.admlevel&&($scope.name_selection=country_name[$scope.country_code]),4>zoom_max&&(document.getElementById("level4").style.visibility="hidden"),3>zoom_max&&(document.getElementById("level3").style.visibility="hidden");var lookup=$scope.genLookup($scope.config.nameAttribute),meta_label=$scope.genLookup_meta(d,"label"),meta_format=$scope.genLookup_meta(d,"format"),meta_unit=$scope.genLookup_meta(d,"unit"),meta_icon=$scope.genLookup_meta(d,"icon_src"),meta_year=$scope.genLookup_meta(d,"year"),meta_source=$scope.genLookup_meta(d,"source_link"),meta_desc=$scope.genLookup_meta(d,"description"),meta_scorevar=$scope.genLookup_meta(d,"scorevar_name");$scope.metric_label=meta_label[$scope.metric],2===$scope.admlevel?($scope.type_selection="Country",$scope.subtype_selection=country_level2[$scope.country_code],$scope.level2_selection=void 0,$scope.level3_selection=void 0,$scope.level2_code="",$scope.level3_code=""):3===$scope.admlevel?($scope.type_selection=country_level2[$scope.country_code],$scope.subtype_selection=country_level3[$scope.country_code],$scope.level2_selection=$scope.name_selection,$scope.level2_code=$scope.parent_code,$scope.level3_selection=void 0,$scope.level3_code=""):4===$scope.admlevel&&($scope.type_selection=country_level3[$scope.country_code],$scope.subtype_selection=country_level4[$scope.country_code],$scope.level3_selection=$scope.name_selection,$scope.level3_code=$scope.parent_code),$scope.tables=[];for(var i=0;i<d.Metadata.length;i++){var record={},record_temp=d.Metadata[i];record.id="data-table"+[i+1],record.name=record_temp.variable,record.group=record_temp.group,record.propertyPath="sum"===record_temp.agg_method?"value":"value.finalVal",record.dimension=void 0,record.weight_var=record_temp.weight_var,record.scorevar_name=record_temp.scorevar_name,$scope.tables[i]=record}var dec0Format=(d3.format(","),d3.format(",.0f")),dec2Format=(d3.format(",.1f"),d3.format(".2f")),percFormat=d3.format(",.2%"),currentFormat=function(value){return"decimal0"===meta_format[$scope.metric]?dec0Format(value):"decimal2"===meta_format[$scope.metric]?dec2Format(value):"percentage"===meta_format[$scope.metric]?percFormat(value):void 0},cf=crossfilter(d.Rapportage),whereDimension=cf.dimension(function(d){return d.pcode}),whereGroupSum_scores=(whereDimension.group().reduceSum(function(d){return d[$scope.metric]}),whereDimension.group().reduceSum(function(d){return meta_scorevar[$scope.metric]?d[meta_scorevar[$scope.metric]]:d[$scope.metric]})),all=cf.groupAll();dc.dataCount("#count-info").dimension(cf).group(all);var reduceAddAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub+=v[metricA]*v[metricB],p.sumOfTotal+=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceRemoveAvg=function(metricA,metricB){return function(p,v){return p.sumOfSub-=v[metricA]*v[metricB],p.sumOfTotal-=v[metricB],p.finalVal=p.sumOfSub/p.sumOfTotal,p}},reduceInitialAvg=function(){return{sumOfSub:0,sumOfTotal:0,finalVal:0}},totaalDim=cf.dimension(function(i){return"Total"}),dimensions=[];$scope.tables.forEach(function(t){var name=t.name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions[name]=totaalDim.group().reduce(reduceAddAvg([name],[weight_var]),reduceRemoveAvg([name],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions[name]=totaalDim.group().reduceSum(function(d){return d[name]}))});var dimensions_scores=[];$scope.tables.forEach(function(t){var name=t.name;if(t.scorevar_name){var name_score=t.scorevar_name;if("value.finalVal"===t.propertyPath){var weight_var=t.weight_var;dimensions_scores[name]=totaalDim.group().reduce(reduceAddAvg([name_score],[weight_var]),reduceRemoveAvg([name_score],[weight_var]),reduceInitialAvg)}else"value"===t.propertyPath&&(dimensions_scores[name]=totaalDim.group().reduceSum(function(d){return d[name_score]}))}});var i;for(i=0;i<d.Metadata.length;i++){var name=$scope.tables[i].name;$scope.tables[i].dimension=dimensions[name]}var fill_keyvalues=function(){var keyvalue=[];return $scope.tables.forEach(function(t){var key=t.name;$scope.admlevel==zoom_max&&zoom_max>zoom_min&&0==$scope.filters.length?"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(d_prev[t.name]):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(d_prev[t.name]):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(d_prev[t.name])):"value.finalVal"===t.propertyPath?isNaN(dimensions[t.name].top(1)[0].value.finalVal)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value.finalVal):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value.finalVal):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value.finalVal)):"value"===t.propertyPath&&(isNaN(dimensions[t.name].top(1)[0].value)?keyvalue[key]="N.A. on this level":"decimal0"===meta_format[t.name]?keyvalue[key]=dec0Format(dimensions[t.name].top(1)[0].value):"percentage"===meta_format[t.name]?keyvalue[key]=percFormat(dimensions[t.name].top(1)[0].value):"decimal2"===meta_format[t.name]&&(keyvalue[key]=dec2Format(dimensions[t.name].top(1)[0].value)))}),keyvalue},keyvalue=fill_keyvalues(),high_med_low=function(ind,ind_score){if(dimensions_scores[ind]){if($scope.admlevel==zoom_max&&zoom_max>zoom_min&&0==$scope.filters.length)var width=d_prev[ind_score];else var width=dimensions_scores[ind].top(1)[0].value.finalVal;if(isNaN(width))return"notavailable";if(3.5>width)return"good";if(4.5>=width)return"medium-good";if(5.5>=width)return"medium";if(6.5>=width)return"medium-bad";if(width>6.5)return"bad"}};$scope.createHTML=function(keyvalue){var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));for(var general=document.getElementById("general"),scores=document.getElementById("scores"),vulnerability=document.getElementById("vulnerability"),hazard=document.getElementById("hazard"),coping=document.getElementById("coping");general.firstChild;)general.removeChild(general.firstChild);for(;scores.firstChild;)scores.removeChild(scores.firstChild);for(;vulnerability.firstChild;)vulnerability.removeChild(vulnerability.firstChild);for(;hazard.firstChild;)hazard.removeChild(hazard.firstChild);for(;coping.firstChild;)coping.removeChild(coping.firstChild);for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if(meta_icon[record.name])var icon="modules/dashboards/img/"+meta_icon[record.name];else var icon="modules/dashboards/img/undefined.png";if("general"===record.group){if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];var div=document.createElement("div");div.setAttribute("class","row profile-item");var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col col-md-1"),div.appendChild(div0);var img=document.createElement("img");img.setAttribute("class","community-icon"),img.setAttribute("src",icon),div0.appendChild(img);var div1=document.createElement("div");div1.setAttribute("class","col col-md-5 general-component-label"),div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],div.appendChild(div1),$compile(div1)($scope);var div2=document.createElement("div");div2.setAttribute("class","col col-md-4"),div2.setAttribute("id",record.name),div2.innerHTML=keyvalue[record.name]+" "+unit,div.appendChild(div2);var div3=document.createElement("div");div3.setAttribute("class","col col-md-2"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img=document.createElement("img");img.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img.setAttribute("style","height:17px"),button.appendChild(img)}else if(record.group){if($scope.admlevel==zoom_max&&zoom_max>zoom_min&&0==$scope.filters.length)var width=10*d_prev[record.scorevar_name];else var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;var div=document.createElement("div");div.setAttribute("class","component-section");var parent=document.getElementById(record.group);parent.appendChild(div);var div0=document.createElement("div");div0.setAttribute("class","col-md-2"),div.appendChild(div0);var img1=document.createElement("img");img1.setAttribute("style","height:20px"),img1.setAttribute("src",icon),div0.appendChild(img1);var div1=document.createElement("div");div1.setAttribute("class","col-md-3 component-label"),div1.setAttribute("ng-click","map_coloring('"+record.name+"')"),div1.innerHTML=meta_label[record.name],$compile(div1)($scope),div.appendChild(div1);var div1a=document.createElement("div");div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.setAttribute("id",record.name),div1a.innerHTML=keyvalue[record.name],div1.appendChild(div1a);var div2=document.createElement("div");div2.setAttribute("class","col-md-5"),div.appendChild(div2);var div2a=document.createElement("div");div2a.setAttribute("class","component-scale"),div2.appendChild(div2a);var div2a1=document.createElement("div");div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name)),div2a1.setAttribute("id","bar-"+record.name),div2a1.setAttribute("style","width:"+width+"%"),div2a.appendChild(div2a1);var img2=document.createElement("img");img2.setAttribute("class","scale-icon"),img2.setAttribute("src","modules/dashboards/img/icon-scale.svg"),div2a.appendChild(img2);var div3=document.createElement("div");div3.setAttribute("class","col-sm-2 col-md-2 no-padding"),div.appendChild(div3);var button=document.createElement("button");button.setAttribute("type","button"),button.setAttribute("class","btn-modal"),button.setAttribute("data-toggle","modal"),button.setAttribute("ng-click","info('"+record.name+"')"),div3.appendChild(button),$compile(button)($scope);var img3=document.createElement("img");img3.setAttribute("src","modules/dashboards/img/icon-popup.svg"),img3.setAttribute("style","height:17px"),button.appendChild(img3)}}},$scope.createHTML(keyvalue),$scope.updateHTML=function(keyvalue){var risk_score=document.getElementById("risk_score_main");risk_score&&(risk_score.textContent=keyvalue.risk_score,risk_score.setAttribute("class","component-score "+high_med_low("risk_score","risk_score")));var vulnerability_score=document.getElementById("vulnerability_score_main");vulnerability_score&&(vulnerability_score.textContent=keyvalue.vulnerability_score,vulnerability_score.setAttribute("class","component-score "+high_med_low("vulnerability_score","vulnerability_score")));var hazard_score=document.getElementById("hazard_score_main");hazard_score&&(hazard_score.textContent=keyvalue.hazard_score,hazard_score.setAttribute("class","component-score "+high_med_low("hazard_score","hazard_score")));var coping_score=document.getElementById("coping_capacity_score_main");coping_score&&(coping_score.textContent=keyvalue.coping_capacity_score,coping_score.setAttribute("class","component-score "+high_med_low("coping_capacity_score","coping_capacity_score")));for(var i=0;i<$scope.tables.length;i++){var record=$scope.tables[i];if("general"===record.group){if("null"===meta_unit[record.name])var unit="";else var unit=meta_unit[record.name];var div2=document.getElementById(record.name);div2.innerHTML=keyvalue[record.name]+" "+unit}else if(record.group){if($scope.admlevel==zoom_max&&zoom_max>zoom_min&&0==$scope.filters.length)var width=10*d_prev[record.scorevar_name];else var width=10*dimensions_scores[record.name].top(1)[0].value.finalVal;var div1a=document.getElementById(record.name);div1a.setAttribute("class","component-score "+high_med_low(record.name,record.scorevar_name)),div1a.innerHTML=keyvalue[record.name];var div2a1=document.getElementById("bar-"+record.name);div2a1.setAttribute("class","score-bar "+high_med_low(record.name,record.scorevar_name)),div2a1.setAttribute("style","width:"+width+"%")}}},$scope.mapchartColors=function(){if(!meta_scorevar[$scope.metric]){var quantile_range=[];for(i=0;i<d.Rapportage.length;i++)quantile_range[i]=d.Rapportage[i][$scope.metric];return d3.scale.quantile().domain(quantile_range).range(["#f1eef6","#bdc9e1","#74a9cf","#2b8cbe","#045a8d"])}};var mapchartColors=$scope.mapchartColors();mapChart.width($("#map-chart").width()).height(800).dimension(whereDimension).group(whereGroupSum_scores).center([0,0]).zoom(0).geojson(d.Districts).colors(mapchartColors).colorCalculator(function(d){
return meta_scorevar[$scope.metric]?0==d?"#cccccc":3.5>d?"#1a9641":4.5>=d?"#a6d96a":5.5>=d?"#f1d121":6.5>=d?"#fd6161":d>6.5?"#d7191c":void 0:d?mapChart.colors()(d):"#cccccc"}).featureKeyAccessor(function(feature){return feature.properties.pcode}).popup(function(d){return lookup[d.key].concat(" - ",meta_label[$scope.metric],": ",currentFormat(d.value))}).renderPopup(!0).turnOnControls(!0).on("filtered",function(chart,filters){$scope.filters=chart.filters();var popup=document.getElementById("mapPopup");popup.style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",$scope.filters.length>mapfilters_length&&($scope.$apply(function(){$scope.name_popup=lookup[$scope.filters[$scope.filters.length-1]];for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[$scope.filters.length-1]){$scope.value_popup=currentFormat(record[$scope.metric]);break}}$scope.metric_label=meta_label[$scope.metric]}),"undefined"!=typeof event?(popup.style.left=event.pageX+"px",popup.style.top=event.pageY+"px"):(popup.style.left="400px",popup.style.top="100px"),popup.style.visibility="visible",$scope.admlevel<zoom_max&&(document.getElementById("zoomin_icon").style.visibility="visible")),mapfilters_length=$scope.filters.length;var keyvalue=fill_keyvalues();$scope.updateHTML(keyvalue);var resetbutton=document.getElementsByClassName("reset-button")[0];$scope.filters.length>0?resetbutton.style.visibility="visible":resetbutton.style.visibility="hidden"}),$scope.zoom_in=function(){if($scope.filters.length>0&&$scope.admlevel<zoom_max){if($scope.admlevel=$scope.admlevel+1,$scope.parent_code_prev=$scope.parent_code,$scope.name_selection_prev=$scope.name_selection,$scope.parent_code=$scope.filters[$scope.filters.length-1],$scope.name_selection=lookup[$scope.parent_code],$scope.admlevel==zoom_max){$scope.metric="population";for(var i=0;i<d.Rapportage.length;i++){var record=d.Rapportage[i];if(record.pcode===$scope.filters[0]){d_prev=record;break}}}$scope.filters=[],$scope.reload(d),document.getElementById("level"+$scope.admlevel).setAttribute("class","btn btn-secondary btn-active"),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden",document.getElementsByClassName("reset-button")[0].style.visibility="hidden",mapfilters_length=0}},$scope.zoom_out=function(dest_level){var admlevel_old=$scope.admlevel;for(2===dest_level&&$scope.admlevel>2?($scope.admlevel=dest_level,$scope.parent_code="",$scope.reload(d)):3===dest_level&&$scope.admlevel>3&&($scope.admlevel=3,$scope.parent_code=$scope.level2_code,$scope.name_selection=$scope.name_selection_prev,$scope.reload(d));admlevel_old>dest_level;)document.getElementById("level"+admlevel_old).setAttribute("class","btn btn-secondary"),admlevel_old-=1;document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden"},$scope.map_coloring=function(id){$scope.metric=id,$scope.metric_label=meta_label[id];var mapchartColors=$scope.mapchartColors();whereGroupSum_scores.dispose(),whereGroupSum_scores=whereDimension.group().reduceSum(function(d){return meta_scorevar[$scope.metric]?d[meta_scorevar[$scope.metric]]:d[$scope.metric]}),mapChart.group(whereGroupSum_scores).colors(mapchartColors).colorCalculator(function(d){return meta_scorevar[$scope.metric]?0==d?"#cccccc":3.5>d?"#1a9641":4.5>=d?"#a6d96a":5.5>=d?"#f1d121":6.5>=d?"#fd6161":d>6.5?"#d7191c":void 0:d?mapChart.colors()(d):"#cccccc"}),dc.filterAll(),dc.redrawAll(),document.getElementById("mapPopup").style.visibility="hidden",document.getElementById("zoomin_icon").style.visibility="hidden"};for(var acc=document.getElementsByClassName("card-header"),active=(document.getElementsByClassName("collapse"),document.getElementsByClassName("collapse in")[0]),i=0;i<acc.length;i++)acc[i].onclick=function(){var active_new=document.getElementById(this.id.replace("heading","collapse"));active.id!==active_new.id&&active.classList.remove("in"),active=active_new};$scope.info=function(id){$scope.metric=id,$scope.metric_label=meta_label[$scope.metric],$scope.metric_year=meta_year[$scope.metric],$scope.metric_source=meta_source[$scope.metric],$scope.metric_desc=meta_desc[$scope.metric],meta_icon[$scope.metric]?$scope.metric_icon="modules/dashboards/img/"+meta_icon[$scope.metric]:$scope.metric_icon="modules/dashboards/img/undefined.png",$("#infoModal").modal("show")},$scope.export_csv=function(){for(var content=d.Rapportage,i=0;i<content.length;i++)content[i].name=lookup[content[i].pcode];for(var finalVal="",i=0;i<content.length;i++){var key,innerValue,result,value=content[i];if(0===i){for(key in value)value.hasOwnProperty(key)&&(innerValue=key,result=innerValue.replace(/"/g,'""'),result.search(/("|,|\n)/g)>=0&&(result='"'+result+'"'),"pcode"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}for(key in value)value.hasOwnProperty(key)&&(innerValue=JSON.stringify(value[key]),result=innerValue.replace(/"/g,'""'),result.search(/("|,|\n)/g)>=0&&(result='"'+result+'"'),"pcode"!==key&&(finalVal+=";"),finalVal+=result);finalVal+="\n"}var download=document.getElementById("download");download.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(finalVal)),download.setAttribute("download","export.csv")},dc.renderAll(),map=mapChart.map(),zoomToGeom($scope.geom)}}]),angular.module("dashboards").controller("StoryboardController",["$scope","$css","$rootScope","Authentication","leafletData",function($scope,$css,$rootScope,Authentication,leafletData){$css.remove("modules/dashboards/css/header.css"),$css.add("modules/dashboards/css/storyboard.css"),$(document).ready(function(){0!==$(".slider").length&&$(".slider").slick({dots:!0,infinite:!1,speed:300,slidesToShow:1,adaptiveHeight:!0,fade:!0,centerMode:!0})}),(new WOW).init(),jQuery(window).load(function(){jQuery("#preloader").delay(100).fadeOut("slow"),jQuery("#load").delay(100).fadeOut("slow")}),$(window).scroll(function(){$(".navbar").offset().top>50?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse")}),$(function(){$(".navbar-nav li a").bind("click",function(event){var $anchor=$(this);$("html, body").stop().animate({scrollTop:$($anchor.attr("href")).offset().top},1500,"easeInOutExpo"),event.preventDefault()}),$(".page-scroll a").bind("click",function(event){var $anchor=$(this);$("html, body").stop().animate({scrollTop:$($anchor.attr("href")).offset().top},1500,"easeInOutExpo"),event.preventDefault()})})}]),angular.module("dashboards").directive("heightresize",["$window",function($window){return{restrict:"A",link:function(scope,elem,attrs){var window=angular.element($window);scope.onResize=function(){$(elem).height($window.innerHeight-$(".navbar").height()-$(".monitorHeader").height())},scope.onResize(),window.bind("resize",function(){scope.onResize(),scope.$apply()})}}}]),angular.module("dashboards").factory("CartoDB",["$resource",function($resource){return $resource("/cartodb/:table",{table:"@_id"},{update:{method:"PUT"}})}]),angular.module("dashboards").factory("Dashboards",["$resource",function($resource){return $resource("dashboards/:dashboardId",{dashboardId:"@_id"},{update:{method:"PUT"}})}]),angular.module("dashboards").factory("Data",["$resource",function($resource){return $resource("data/:adminLevel",{adminLevel:"@_id"})}]),angular.module("dashboards").factory("Dropbox",["$resource",function($resource){return $resource("/dropbox/:file",{file:"@_id"},{update:{method:"PUT"}})}]),angular.module("dashboards").factory("GoogleSpreadsheet",["$resource",function($resource){return $resource("/googlespreadsheet/:id",{id:"@_id"},{update:{method:"PUT"}})}]),angular.module("dashboards").factory("Sources",["$resource",function($resource){return $resource("/sources/:id",{id:"@_id"})}]),angular.module("dashboards").run(["Menus","gettextCatalog",function(Menus,gettextCatalog){var title=gettextCatalog.getString("Data management");Menus.addMenuItem("topbar",title,"forms","forms",!0)}]),angular.module("formsAngular").config(["cssFrameworkServiceProvider",function(cssFrameworkService){cssFrameworkService.setOptions({framework:"bs3"})}]),angular.module("forms").config(["routingServiceProvider",function(routingService){routingService.start({html5Mode:!1,routing:"uirouter",prefix:"/forms",hashPrefix:"!",templatePath:"modules/forms/views/",fixedRoutes:[{route:"/forms",state:"model::all",templateUrl:"modules/forms/views/list-forms.html"}]})}]),angular.module("forms").controller("FormsController",["$scope","$stateParams","$location","Authentication","Forms",function($scope,$stateParams,$location,Authentication,Forms){$scope.authentication=Authentication,$scope.find=function(){$scope.forms=Forms.query()}}]),angular.module("forms").factory("Forms",["$resource",function($resource){return $resource("api/models",{},{query:{method:"GET",isArray:!0}})}]),angular.module("maps").run(["Menus","gettextCatalog",function(Menus,gettextCatalog){var title=gettextCatalog.getString("Maps");Menus.addMenuItem("topbar",title,"maps","/maps",!0)}]),angular.module("maps").config(["$stateProvider",function($stateProvider){$stateProvider.state("listMaps",{url:"/maps",templateUrl:"modules/maps/views/list-maps.client.view.html"}).state("createMap",{url:"/maps/create",templateUrl:"modules/maps/views/create-map.client.view.html"}).state("proxy",{url:"/maps/proxy/:url",templateUrl:"modules/maps/views/create-map.client.view.html"}).state("viewMap",{url:"/maps/:mapId",templateUrl:"modules/maps/views/view-map.client.view.html"}).state("viewMapCenter",{url:"/maps/:mapId/:centerLat/:centerLng/:centerZoom/:activeLayers",templateUrl:"modules/maps/views/view-map.client.view.html"}).state("editMap",{url:"/maps/:mapId/edit",templateUrl:"modules/maps/views/edit-map.client.view.html"}).state("icons",{url:"/icons",templateUrl:"modules/maps/views/icons.client.view.html"})}]),angular.module("maps").controller("MapsController",["$scope","$stateParams","$location","Authentication","Maps","$window","leafletData","$compile","$parse","Proxy","$modal","_",function($scope,$stateParams,$location,Authentication,Maps,$window,leafletData,$compile,$parse,Proxy,$modal,_){$scope.authentication=Authentication,$scope.L=$window.L,$scope.cartodb=$window.cartodb,$scope.LMap=null,$scope.subLayers=[],$scope.bounds=null,$scope.overlayLayers={},$scope.activeLayers=[],$scope.baseLayers={},$scope.wmsLegends=[],$scope.wfsLegends=[],$scope.visualisationLegends=[],$scope.infos={},$scope.mapCenter={},$scope.baseUrl=$location.absUrl().substring(0,$location.absUrl().length-$location.path().length),$scope.mapParameters=$location.path().split("/").slice(0,3).join("/"),$scope.columns=4,$scope.defaults.tileLayer="",$scope.create=function(){var map=new Maps({title:this.title});map.$save(function(response){$location.path("maps/"+response._id)},function(errorResponse){$scope.addAlert("danger",errorResponse.data.message)}),this.title=""},$scope.remove=function(map){if(map){map.$remove();for(var i in $scope.maps)$scope.maps[i]===map&&$scope.maps.splice(i,1)}else $scope.map.$remove(function(){$location.path("maps")})},$scope.update=function(){var map=$scope.map;map.$update(function(){$location.path("maps/"+map._id)},function(errorResponse){$scope.addAlert("danger",errorResponse.data.message)})},$scope.categories=[];var findCategories=function(){angular.forEach($scope.maps,function(value,category){null!==value.category&&-1===$scope.categories.indexOf(value.category.name)&&$scope.categories.push(value.category.name)})};$scope.find=function(){Maps.query(function(data){$scope.maps=data,findCategories(),$scope.prepareMapsList()},function(error){$scope.addAlert("danger",error.data.message)})},$scope.$watch("showCategory",function(){$scope.prepareMapsList()}),$scope.findOne=function(){Maps.get({mapId:$stateParams.mapId},function(data){$scope.map=data},function(error){$scope.addAlert("danger",error.data.message)})},$scope.addActiveLayer=function(id){-1===$scope.activeLayers.indexOf(id)&&$scope.activeLayers.push(id)},$scope.deleteActiveLayer=function(id){var index=$scope.activeLayers.indexOf(id);index>-1&&$scope.activeLayers.splice(index,1)},$scope.prepareMapsList=function(){if("undefined"!=typeof $scope.maps){var newArr=$scope.maps,filteredArr=newArr;"undefined"!=typeof $scope.showCategory&&" "!==$scope.showCategory&&(filteredArr=_.filter(newArr,function(map){return"undefined"==typeof map.category||null===map.category?!1:map.category.name===$scope.showCategory}));var sorted=_.sortBy(filteredArr,function(map){return map.title.toLowerCase()});$scope.splitMaps=[];for(var i=0;i<sorted.length;i+=$scope.columns)$scope.splitMaps.push(sorted.slice(i,i+$scope.columns))}},$scope.alerts=[],$scope.addAlert=function(messageType,message){$scope.alerts.push({type:messageType,msg:message})},$scope.closeAlert=function(index){$scope.alerts.splice(index,1)},$scope.loadSearchControl=function(cartomap){function googleGeocoding(text,callResponse){geocoder.geocode({address:text},callResponse)}function filterJSONCall(rawjson){var key,loc,json={};for(var i in rawjson)key=rawjson[i].formatted_address,loc=$scope.L.latLng(rawjson[i].geometry.location.lat(),rawjson[i].geometry.location.lng()),json[key]=loc;return json}var geocoder=new google.maps.Geocoder;cartomap.addControl(new $scope.L.Control.Search({container:"findbox",text:"Zoeken...",textCancel:"Cancel",textErr:"Locatie niet gevonden",sourceData:googleGeocoding,formatData:filterJSONCall,markerLocation:!0,autoType:!1,autoCollapse:!0,minLength:2}))};var addVisualisation=function(cartomap,visualisation){$scope.cartodb.createLayer(cartomap,visualisation.apiUrl,{https:!0,legends:!1}).addTo(cartomap).on("done",function(layer){if(layer.setInteraction(!0),layer.setZIndex(visualisation.zindex),layer.layer_name=visualisation.name,layer.parentId=visualisation._id,layer.options.visible=visualisation.visible,visualisation.visible?$scope.addActiveLayer(visualisation._id):$scope.LMap.removeLayer(layer),$scope.overlayLayers[visualisation.name]=layer,layer.layers[0].hasOwnProperty("legend")&&"none"!==layer.layers[0].legend.type){var legend={},cartoLegend=layer.layers[0].legend;cartoLegend.data=cartoLegend.items;var rendered=new cdb.geo.ui.Legend(cartoLegend).render().el;legend.html=rendered.outerHTML,legend.name=visualisation.name,$scope.visualisationLegends.push(legend)}layer.on("featureOver",function(e,pos,latlng,data){$scope.cartodb.log.log(e,pos,latlng,data)}),layer.on("error",function(err){$scope.cartodb.log.log("error: "+err)})}).on("error",function(){$scope.cartodb.log.log("some error occurred")})},addWmsLayer=function(cartomap,wmsLayer){var wms=null;if(wms=wmsLayer.tiled?wmsLayer.featureInfo?$scope.L.tileLayer.betterWms(wmsLayer.url,{layers:wmsLayer.layers,format:wmsLayer.format,transparent:wmsLayer.transparent,version:wmsLayer.version}):$scope.L.tileLayer.wms(wmsLayer.url,{layers:wmsLayer.layers,format:wmsLayer.format,transparent:wmsLayer.transparent,version:wmsLayer.version}):new $scope.L.NonTiledLayer.WMS(wmsLayer.url,{layers:wmsLayer.layers,format:wmsLayer.format,transparent:wmsLayer.transparent,version:wmsLayer.version,pane:cartomap.getPanes().tilePane,zIndex:wmsLayer.zindex,opacity:wmsLayer.opacity},wmsLayer.featureInfo),null!==wms){wms.addTo(cartomap);wms.setZIndex(wmsLayer.zindex),wms.layer_name=wmsLayer.name,wms.parentId=wmsLayer._id,wms.options.visible=wmsLayer.visible,wmsLayer.visible?$scope.addActiveLayer(wmsLayer._id):$scope.LMap.removeLayer(wms),$scope.overlayLayers[wmsLayer.name]=wms;var legendOptions=wmsLayer.legendOptions;""!==wmsLayer.legendOptions&&(legendOptions=JSON.parse(wmsLayer.legendOptions));var legends=wms.getLegendGraphic(legendOptions),legend={};for(var l in legends)legend.url=legends[l],legend.name=wmsLayer.name,$scope.wmsLegends.push(legend)}},addWfsLayer=function(cartomap,wfsLayer){function style(feature){return{weight:wfsLayer.featureStyle.weight,opacity:wfsLayer.featureStyle.opacity,color:wfsLayer.featureStyle.color,dashArray:wfsLayer.featureStyle.dashArray,fillOpacity:wfsLayer.featureStyle.fillOpacity,fillColor:wfsLayer.featureStyle.fillColor}}function featureUrl(wfsLayer){var crsString="",crs="";wfsLayer.crs.length>0&&(crs=wfsLayer.crs[0],crs.indexOf("EPSG")>-1&&crs.indexOf(!1)&&(crs=[crs.slice(0,4),":",crs.slice(4)].join("")),crsString="&srsName="+crs);var bboxString="";if(null!==$scope.bounds){var bboxCrs="";""!==crs&&(bboxCrs=","+crs),bboxString="&BBOX="+$scope.bounds.toBBoxString()+bboxCrs}return encodeURIComponent(wfsLayer.url+"?request=GetFeature&outputformat=json&version="+wfsLayer.version+"&typeName="+wfsLayer.featureType+crsString+bboxString)}function onEachFeature(feature,layer){feature.properties&&feature.properties[wfsLayer.hoverProperty]&&layer.bindPopup(feature.properties[wfsLayer.hoverProperty])}function pointToLayer(feature,latlng){return $scope.L.circleMarker(latlng,geojsonMarkerOptions)}var geojsonMarkerOptions={radius:wfsLayer.markerStyle.radius,fillColor:wfsLayer.markerStyle.fillColor,color:wfsLayer.markerStyle.color,weight:wfsLayer.markerStyle.weight,opacity:wfsLayer.markerStyle.opacity,fillOpacity:wfsLayer.markerStyle.fillOpacity};$scope.loading=Proxy.get({url:featureUrl(wfsLayer)}).$promise.then(function(response){response.type&&"FeatureCollection"===response.type&&$scope.L.geoJson(response,{pointToLayer:pointToLayer,style:style,onEachFeature:onEachFeature}).addTo(cartomap).on("done",function(layer){layer.setZIndex(wfsLayer.zindex),layer.layer_name=wfsLayer.name,layer.parentId=wfsLayer._id,layer.options.visible=wfsLayer.visible,wfsLayer.visible?$scope.addActiveLayer(wfsLayer._id):$scope.LMap.removeLayer(layer),$scope.overlayLayers[wfsLayer.name]=layer})})};$scope.loadLayers=function(){leafletData.getMap().then(function(cartomap){$scope.LMap=cartomap,cartomap.on("moveend",function(){$scope.bounds=cartomap.getBounds();var center=cartomap.getCenter(),zoom=cartomap.getZoom();$scope.mapCenter.lat=center.lat,$scope.mapCenter.lng=center.lng,$scope.mapCenter.zoom=zoom});var gpsStyle={radius:3,weight:8,color:"#4C87C7",fill:!0,opacity:1};cartomap.addControl(new $scope.L.Control.Gps({style:gpsStyle})),Maps.get({mapId:$stateParams.mapId}).$promise.then(function(map){var baseMap=map.baseMap;if(void 0!==map.baseMap&&null!==map.baseMap){var layer=$scope.L.tileLayer(baseMap.url,{attribution:'&copy; <a href="http://www.rodekruis.nl" target="_new">Rode Kruis</a>'});cartomap.addLayer(layer),layer.layer_name=baseMap.name,layer.setZIndex(1),$scope.baseLayers[baseMap.name]=layer}$stateParams.centerLat&&$stateParams.centerLng&&$stateParams.centerZoom?cartomap.setView(new $scope.L.latLng($stateParams.centerLat,$stateParams.centerLng),$stateParams.centerZoom):($scope.mapCenter=map.mapCenter,cartomap.setView(new $scope.L.latLng($scope.mapCenter.lat,$scope.mapCenter.lng),$scope.mapCenter.zoom)),$scope.infos.title=map.title,$scope.infos.info=map.description,$scope.infos.layers=[];var urlLayersSet=!1,activeLayers=[];$stateParams.activeLayers&&(activeLayers=$stateParams.activeLayers.split(","),urlLayersSet=!0);for(var vId in map.visualisation){var visualisation=map.visualisation[vId];urlLayersSet&&(activeLayers.indexOf(visualisation._id)>-1?visualisation.visible=!0:visualisation.visible=!1),addVisualisation(cartomap,visualisation),$scope.infos.layers.push({title:visualisation.name,info:visualisation.description})}for(var wmsId in map.wmsLayer){var wmsLayer=map.wmsLayer[wmsId];urlLayersSet&&(activeLayers.indexOf(map.wmsLayer[wmsId]._id)>-1?wmsLayer.visible=!0:wmsLayer.visible=!1),addWmsLayer(cartomap,wmsLayer),$scope.infos.layers.push({title:wmsLayer.name,info:wmsLayer.description})}for(var wfsId in map.wfsLayer){var wfsLayer=map.wfsLayer[wfsId];urlLayersSet&&(activeLayers.indexOf(map.wfsLayer[wfsId]._id)>-1?wfsLayer.visible=!0:wfsLayer.visible=!1),addWfsLayer(cartomap,wfsLayer),$scope.infos.layers.push({title:wfsLayer.name,info:wfsLayer.description})}}),cartomap.invalidateSize(),$scope.loadSearchControl(cartomap)}),$scope.toggleLayer=function(layer,e){e.preventDefault(),e.stopPropagation(),$scope.LMap.hasLayer(layer)?($scope.LMap.removeLayer(layer),layer.options.visible=!1,$scope.deleteActiveLayer(layer.parentId)):($scope.LMap.addLayer(layer),layer.options.visible=!0,$scope.addActiveLayer(layer.parentId))}}}]),angular.module("maps").directive("layermenu",function($compile){return{template:"<div></div>",replace:!0,link:function(scope,element){var container=scope.menuContainer;$compile(container)(scope),element.append(container)}}}).directive("htmlparse",[function($compile,$parse){return{template:"<div></div>",restrict:"E",link:function(scope,element,attr){$parse(attr.content)(scope);element.html=angular.element($parse(attr.content)(scope));var test=$compile(element)(scope);element.append(test)}}}]).directive("ngLegendClick",["$modal",function($modal,$compile,$parse){var ModalInstanceCtrl=function($scope,$modalInstance,wmsLegends,wfsLegends,visualisationLegends){$scope.wmsLegends=wmsLegends,$scope.wfsLegends=wfsLegends,$scope.visualisationLegends=visualisationLegends,$scope.ok=function(){$modalInstance.close()}};return{restrict:"A",scope:!0,link:function(scope,element,attrs){element.bind("click",function(){var modalInstance=$modal.open({templateUrl:"modules/maps/views/legends.client.template.html",controller:ModalInstanceCtrl,size:scope.size,resolve:{wmsLegends:function(){return scope.wmsLegends},wfsLegends:function(){return scope.wfsLegends},visualisationLegends:function(){return scope.visualisationLegends}}});modalInstance.result.then(function(){},function(){})})}}}]).directive("ngInfoClick",["$modal",function($modal,$compile,$parse){var ModalInstanceCtrl=function($scope,$modalInstance,infos){$scope.infos=infos,$scope.ok=function(){$modalInstance.close()}};return{restrict:"A",scope:!0,link:function(scope,element,attrs){element.bind("click",function(){var modalInstance=$modal.open({templateUrl:"modules/maps/views/infos.client.template.html",controller:ModalInstanceCtrl,size:scope.size,resolve:{infos:function(){return scope.infos}}});modalInstance.result.then(function(){},function(){})})}}}]).directive("ngShareClick",["$modal",function($modal,$compile,$parse){var ModalInstanceCtrl=function($scope,$modalInstance,mapCenter,baseUrl,mapParameters,activeLayers){$scope.mapCenter=mapCenter,$scope.baseUrl=baseUrl,$scope.mapParameters=mapParameters,$scope.activeLayers=activeLayers,$scope.ok=function(){$modalInstance.close()}};return{restrict:"A",scope:!0,link:function(scope,element,attrs){element.bind("click",function(){var modalInstance=$modal.open({templateUrl:"modules/maps/views/share.client.template.html",controller:ModalInstanceCtrl,size:scope.size,resolve:{mapCenter:function(){return scope.mapCenter},baseUrl:function(){return scope.baseUrl},mapParameters:function(){return scope.mapParameters},activeLayers:function(){return scope.activeLayers.join(",")}}});modalInstance.result.then(function(){},function(){})})}}}]).directive("heightresize",["$window",function($window,$rootScope){return{restrict:"A",link:function(scope,elem,attrs){var window=angular.element($window);scope.onResize=function(){$(elem).height(window.height()-$(".navbar").height()-$(".mapHeader").height()),"undefined"!=typeof $rootScope&&$rootScope.hasOwnProperty("LMap")&&$rootScope.LMap.invalidateSize()},scope.onResize(),window.bind("resize",function(){scope.onResize(),scope.$apply()})}}}]),angular.module("maps").filter("unsafehtml",["$sce",function($sce){return function(input){return $sce.trustAsHtml(input)}}]).filter("unsafesource",["$sce",function($sce){return function(input){return $sce.trustAsResourceUrl(input)}}]),angular.module("maps").factory("_",["$window",function($window){return $window._}]).factory("Maps",["$resource",function($resource){return $resource("maps/:mapId",{mapsId:"@_id"},{update:{method:"PUT"}})}]).factory("Proxy",["$resource",function($resource){return $resource("proxy/:url",{url:"@_id"})}]).factory("CartoDB",["$resource",function($resource){return $resource("cartodb/:table",{table:"@_id"})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/signin.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication","$window",function($scope,$http,$location,Users,Authentication,$window){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response,$window.location.reload()},function(response){$scope.error=response.data.message})},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})},$scope.languages=[{id:"nl_NL",name:"Nederlands"},{id:"en_EN",name:"English"}]}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);